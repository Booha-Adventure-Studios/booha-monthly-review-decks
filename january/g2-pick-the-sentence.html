<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Booha Review Decks – Pick the Sentence (January)</title>
<meta name="theme-color" content="#0b1020" />
<link rel="icon" type="image/png" href="BoohaYellow.png">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Noto+Sans+JP:wght@500;700;900&display=swap" rel="stylesheet" />

<style>
:root{
  --bg:#0b1020;
  --panel:#0f172a;
  --panel2:#0b1327;
  --ink:#ffffff;
  --muted:#cbd5e1;
  --outline:rgba(255,255,255,.18);
  --good:#22c55e;
  --bad:#e53935;
  --gold:#ffd17a;
  --shadow: 0 18px 45px rgba(0,0,0,.45);
  --radius:28px;
  --btnR:22px;

  --jpSize: clamp(26px, 3.3vw, 44px);
  --hiSize: clamp(18px, 2.4vw, 30px);
  --enSize: clamp(20px, 2.6vw, 34px);
  --hudSize: 14px;

  /* default calm */
  --fireA: rgba(255,209,122,.12);
  --fireB: rgba(255,120,70,.08);
  --ringA: rgba(255,209,122,.22);
  --ringB: rgba(255,120,70,.14);
  --pulse1: rgba(255,209,122,.22);
  --pulse2: rgba(255,120,70,.22);

  --unlockGlow: rgba(255,209,122,.00);
  --unlockScale: 1;
  --unlockWobble: 0deg;

  --bgP: rgba(124,58,237,.46);
  --bgB: rgba(94,230,255,.30);
  --bgG: rgba(255,209,122,.26);

  --stormA: rgba(255,126,185,.00);
  --stormB: rgba(94,230,255,.00);
  --stormC: rgba(255,209,122,.00);
  --fireSpark: 0;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:
    radial-gradient(1200px 760px at 28% 18%, var(--bgP), transparent 58%),
    radial-gradient(980px 720px  at 76% 26%, var(--bgB), transparent 60%),
    radial-gradient(980px 760px  at 52% 92%, var(--bgG), transparent 62%),
    var(--bg);
  color:var(--ink);
  font-family:'Cinzel', serif;
  overflow:hidden;
}

body::before{
  content:"";
  position:fixed;
  inset:-12%;
  pointer-events:none;
  z-index:0;
  background:
    radial-gradient(900px 650px at 20% 20%, rgba(255,126,185,.24), transparent 60%),
    radial-gradient(900px 650px at 82% 30%, rgba(94,230,255,.20), transparent 62%),
    radial-gradient(900px 650px at 55% 85%, rgba(255,209,122,.20), transparent 62%),
    radial-gradient(900px 650px at 35% 65%, rgba(124,58,237,.22), transparent 62%);
  filter: blur(10px) saturate(1.35);
  opacity:.95;
  mix-blend-mode: screen;
  transform: translate3d(0,0,0);
  animation: auroraDrift 8.5s ease-in-out infinite;
}
@keyframes auroraDrift{
  0%   {transform: translate(-2%, -1%) scale(1.02)}
  50%  {transform: translate( 2%,  1%) scale(1.06)}
  100% {transform: translate(-2%, -1%) scale(1.02)}
}

body::after{
  content:"";
  position:fixed;
  inset:-10%;
  pointer-events:none;
  z-index:0;
  background:
    radial-gradient(900px 700px at 30% 18%, var(--stormA), transparent 62%),
    radial-gradient(1000px 760px at 70% 28%, var(--stormB), transparent 62%),
    radial-gradient(980px 760px at 50% 86%, var(--stormC), transparent 62%),
    conic-gradient(from 210deg at 50% 45%,
      rgba(255,209,122, calc(.03 + var(--fireSpark)*.06)),
      rgba(255,120,70,  calc(.02 + var(--fireSpark)*.06)),
      rgba(94,230,255,  calc(.02 + var(--fireSpark)*.06)),
      rgba(124,58,237,  calc(.02 + var(--fireSpark)*.06)),
      rgba(255,126,185, calc(.02 + var(--fireSpark)*.06)),
      rgba(255,209,122, calc(.03 + var(--fireSpark)*.06))
    );
  filter: blur(14px) saturate(1.55) contrast(1.05);
  opacity: .85;
  mix-blend-mode: screen;
  animation: fireStorm 3.2s ease-in-out infinite;
}
@keyframes fireStorm{
  0%   {transform: translate(-1.5%, -1%) rotate(-2deg) scale(1.02)}
  50%  {transform: translate( 1.5%,  1%) rotate( 2deg) scale(1.06)}
  100% {transform: translate(-1.5%, -1%) rotate(-2deg) scale(1.02)}
}

/* ===========================
   REMINDER: FIRE LEVELS — make each level MORE colorful + brighter
   (Edit these existing blocks)
   =========================== */
body.fire1{
  /* bump these a bit more */
  --fireA: rgba(255,209,122,.48);
  --fireB: rgba(255,120,70,.32);
  --ringA: rgba(255,209,122,.72);
  --ringB: rgba(255,120,70,.54);
  --pulse1: rgba(255,209,122,.82);
  --pulse2: rgba(255,120,70,.70);

  --bgP: rgba(124,58,237,.78);
  --bgB: rgba(94,230,255,.56);
  --bgG: rgba(255,209,122,.60);

  --stormA: rgba(255,126,185,.36);
  --stormB: rgba(94,230,255,.32);
  --stormC: rgba(255,209,122,.32);
  --fireSpark: .75;
}

body.fire2{
  /* push saturation/brightness */
  --fireA: rgba(255,209,122,.82);
  --fireB: rgba(255,120,70,.62);
  --ringA: rgba(255,209,122,.98);
  --ringB: rgba(255,120,70,.92);
  --pulse1: rgba(255,209,122,1.00);
  --pulse2: rgba(255,120,70,1.00);

  --bgP: rgba(124,58,237,1.00);
  --bgB: rgba(94,230,255,.78);
  --bgG: rgba(255,209,122,.82);

  --stormA: rgba(255,126,185,.58);
  --stormB: rgba(94,230,255,.50);
  --stormC: rgba(255,209,122,.50);
  --fireSpark: 1.10;
}

body.fire3{
  /* make this feel like “MAX” before 4 */
  --fireA: rgba(255,255,255,.18);
  --fireB: rgba(255,209,122,1.00);
  --ringA: rgba(255,255,255,.40);
  --ringB: rgba(255,120,70,1.00);
  --pulse1: rgba(255,255,255,.42);
  --pulse2: rgba(94,230,255,.70);

  --bgP: rgba(255,126,185,.44);
  --bgB: rgba(94,230,255,.62);
  --bgG: rgba(255,209,122,.94);

  --stormA: rgba(255,126,185,.78);
  --stormB: rgba(94,230,255,.68);
  --stormC: rgba(255,209,122,.68);
  --fireSpark: 1.35;
}

body.fire4{
  /* “rock concert party” = neon + white-hot highlights */
  --fireA: rgba(255,255,255,.28);
  --fireB: rgba(255,214,102,1.00);
  --ringA: rgba(255,255,255,.75);
  --ringB: rgba(255,90,160,1.00);
  --pulse1: rgba(255,255,255,.85);
  --pulse2: rgba(90,255,214,.92);

  --bgP: rgba(255,90,160,.72);
  --bgB: rgba(90,255,214,.62);
  --bgG: rgba(255,214,102,.72);

  --stormA: rgba(255,90,160,.78);
  --stormB: rgba(90,255,214,.70);
  --stormC: rgba(255,214,102,.70);
  --fireSpark: 1.75;
}


/* apply enhanced background layering when in any fire state */
body.fire1, body.fire2, body.fire3, body.fire4{
  background:
    radial-gradient(1100px 760px at 50% 16%, var(--fireA), transparent 60%),
    radial-gradient(980px 720px  at 50% 46%, var(--fireB), transparent 62%),
    radial-gradient(980px 760px  at 50% 92%, rgba(255,209,122,.24), transparent 62%),
    radial-gradient(1200px 760px at 28% 18%, var(--bgP), transparent 58%),
    radial-gradient(980px 720px  at 76% 26%, var(--bgB), transparent 60%),
    radial-gradient(980px 760px  at 52% 92%, var(--bgG), transparent 62%),
    var(--bg);
}

/* ===========================
   REMINDER: FIRE4 STORM — make it feel louder
   (Edit this existing block)
   =========================== */
body.fire4::after{
  animation-duration: 1.75s;                 /* faster */
  filter: blur(14px) saturate(1.95) contrast(1.12);
  opacity: .98;
}


/* ===========================
   REMINDER: FIRE4 ROCK-CONCERT LIGHT BEAMS (ADD THIS NEW BLOCK)
   Put this near your other fire4-only effects, e.g. near body.fire4::after
   =========================== */
body.fire4::before{
  content:"";
  position:fixed;
  inset:-20%;
  pointer-events:none;
  z-index:0;

  /* stage beams */
  background:
    linear-gradient(115deg, rgba(255,255,255,.10), transparent 35%),
    linear-gradient(245deg, rgba(90,255,214,.12), transparent 40%),
    linear-gradient(300deg, rgba(255,90,160,.12), transparent 42%),
    radial-gradient(900px 700px at 50% 50%, rgba(255,214,102,.10), transparent 60%);

  mix-blend-mode: screen;
  filter: blur(1px) saturate(1.2);
  opacity:.95;
  transform: translate3d(0,0,0);
  animation: concertBeams 2.2s ease-in-out infinite;
}

@keyframes concertBeams{
  0%   {transform: translate(-1%, -1%) rotate(-1.5deg) scale(1.02)}
  50%  {transform: translate( 1%,  1%) rotate( 1.5deg) scale(1.06)}
  100% {transform: translate(-1%, -1%) rotate(-1.5deg) scale(1.02)}
}
  

/* ========================= */

.wrap{
  position:relative;
  z-index:1;
  height:100%;
  display:flex;
  flex-direction:column;
  padding: max(14px, env(safe-area-inset-top)) 14px max(14px, env(safe-area-inset-bottom));
  gap:12px;
}

.topbar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}

.back{
  appearance:none;
  border:0;
  background:rgba(255,255,255,.10);
  color:#fff;

  /* smaller + tighter (standardized) */
  padding:7px 10px;
  font-size:14px;
  gap:8px;

  border-radius:999px;
  font-family:'Cinzel',serif;
  font-weight:900;
  letter-spacing:.4px;
  box-shadow: 0 10px 24px rgba(0,0,0,.35);
  border:1px solid rgba(255,255,255,.18);
  cursor:pointer;
  display:flex;
  align-items:baseline;
  -webkit-tap-highlight-color: transparent;
}
.back span.jp{
  font-family:'Noto Sans JP',sans-serif;
  font-weight:900;
  font-size:10px;
  opacity:.95;
}
.back span[aria-hidden="true"]{font-size:14px;}

.hud{
  display:flex;
  align-items:center;
  gap:10px;
  font-family:'Noto Sans JP',sans-serif;
  font-size:var(--hudSize);
  color:var(--muted);
  user-select:none;
}
.hud .pill{
  padding:8px 10px;
  border-radius:999px;
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.14);
}
.hud b{color:#fff}

.stage{
  flex:1;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:14px;
  min-height:0;
}

.card{
  width:min(980px, 100%);
  border-radius:var(--radius);
  background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
  border:1px solid rgba(255,255,255,.18);
  box-shadow: var(--shadow);
  padding:18px 18px 16px;
  position:relative;
  overflow:hidden;
  transform: scale(var(--unlockScale)) rotate(var(--unlockWobble));
  transition: transform .25s ease, box-shadow .25s ease;
}
body.fire2 .card,
body.fire3 .card,
body.fire4 .card{
  box-shadow:
    var(--shadow),
    0 0 60px var(--unlockGlow),
    0 0 140px rgba(255,209,122, calc(.08 + var(--fireSpark)*.10));
}
body.fire3 .card{ animation: cardThrill 0.85s ease-in-out infinite; }

/* fire4: wilder (but not unreadable) */
body.fire4 .card{ animation: cardThrillWild 0.70s ease-in-out infinite; }
@keyframes cardThrill{
  0%,100%{ transform: scale(var(--unlockScale)) rotate(calc(var(--unlockWobble) * -1)); }
  50%{ transform: scale(calc(var(--unlockScale) + .015)) rotate(var(--unlockWobble)); }
}
@keyframes cardThrillWild{
  0%,100%{ transform: scale(var(--unlockScale)) rotate(calc(var(--unlockWobble) * -1)); }
  50%{ transform: scale(calc(var(--unlockScale) + .02)) rotate(var(--unlockWobble)); }
}

.card::before{
  content:"";
  position:absolute;
  inset:-2px;
  border-radius:var(--radius);
  background:
    radial-gradient(520px 220px at 30% 0%, rgba(255,255,255,.12), transparent 60%),
    radial-gradient(560px 260px at 80% 0%, rgba(255,209,122,.18), transparent 62%),
    radial-gradient(900px 380px at 50% 120%, rgba(255,120,70, calc(.06 + var(--fireSpark)*.10)), transparent 62%);
  pointer-events:none;
}

/* extra shimmer overlay for fire4 */
body.fire4 .card::after{
  content:"";
  position:absolute;
  inset:-40%;
  background: conic-gradient(from 0deg at 50% 50%,
    rgba(255,214,102,0),
    rgba(255,214,102,.22),
    rgba(255,90,160,.18),
    rgba(90,255,214,.18),
    rgba(120,130,255,.16),
    rgba(255,214,102,.22),
    rgba(255,214,102,0)
  );
  filter: blur(12px);
  opacity:.55;
  mix-blend-mode: screen;
  animation: wildSpin 1.8s linear infinite;
  pointer-events:none;
}
@keyframes wildSpin{to{transform: rotate(360deg);} }

.prompt{
  position:relative;
  z-index:1;
  text-align:center;
  padding:14px 8px 8px;
  transform-origin: 50% 50%;
  will-change: transform;
}

.jp{
  font-family:'Noto Sans JP',sans-serif;
  font-weight:900;
  font-size:var(--jpSize);
  line-height:1.12;
  text-shadow:
    0 2px 0 rgba(0,0,0,.90),
    0 0 10px rgba(0,0,0,.80),
    0 0 18px rgba(0,0,0,.60),
    0 10px 26px rgba(0,0,0,.45);
}
.hira{
  margin-top:10px;
  font-family:'Noto Sans JP',sans-serif;
  font-weight:800;
  font-size:var(--hiSize);
  line-height:1.12;
  color: rgba(255,255,255,.92);
  opacity:.95;
  text-shadow:
    0 2px 0 rgba(0,0,0,.85),
    0 0 10px rgba(0,0,0,.70),
    0 0 18px rgba(0,0,0,.50);
}

.grid{
  width:min(980px, 100%);
  display:grid;
  grid-template-columns: 1fr;
  gap:12px;
}
@media (min-width: 820px){
  .grid{grid-template-columns: 1fr 1fr;}
}

.choice{
  position:relative;
  border-radius:var(--btnR);
  padding:16px 16px 18px;
  background:#ffffff;
  border:1px solid rgba(255,255,255,.18);
  box-shadow: 0 12px 28px rgba(0,0,0,.35);
  cursor:pointer;
  user-select:none;
  transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
  overflow:hidden;
}
.choice:hover{transform: translateY(-1px)}
.choice:active{transform: translateY(0px) scale(.995)}
.choice .en{
  font-family: Arial, Helvetica, sans-serif;
  font-weight: 800;
  font-size: var(--enSize);
  line-height: 1.15;
  color: #0b1020;
}
.choice.locked{pointer-events:none; opacity:.92}

.choice.correct{
  border-color: #22c55e;
  box-shadow:
    0 0 0 6px rgba(34,197,94,.35),
    0 0 40px rgba(34,197,94,.90),
    0 0 90px rgba(34,197,94,.45),
    0 12px 28px rgba(0,0,0,.35);
  animation: correctFlash .22s ease-out;
}
@keyframes correctFlash{ from{transform: scale(.96);} to{transform: scale(1);} }

.choice.wrong{
  border-color: #ff3b3b;
  box-shadow:
    0 0 0 6px rgba(255,59,59,.35),
    0 0 45px rgba(255,59,59,.85),
    0 0 95px rgba(255,59,59,.45),
    0 12px 28px rgba(0,0,0,.35);
  animation: shake .45s ease;
}
@keyframes shake{
  0%,100%{transform:translateX(0)}
  20%{transform:translateX(-10px)}
  40%{transform:translateX(10px)}
  60%{transform:translateX(-7px)}
  80%{transform:translateX(7px)}
}

/* ✅ WRONG reveal: no pill popup. Just glow the correct answer green. */
.choice.correctGlow{
  border-color: rgba(34,197,94,.95);
  box-shadow:
    0 0 0 6px rgba(34,197,94,.22),
    0 0 40px rgba(34,197,94,.70),
    0 0 90px rgba(34,197,94,.40),
    0 12px 28px rgba(0,0,0,.35);
}

.fireRing{
  position:absolute;
  inset:10px;
  border-radius: calc(var(--radius) - 10px);
  pointer-events:none;
  opacity:0;
  transition: opacity .25s ease;
  background:
    radial-gradient(600px 220px at 30% 0%, var(--ringA), transparent 62%),
    radial-gradient(600px 240px at 70% 0%, var(--ringB), transparent 62%),
    radial-gradient(700px 260px at 50% 110%, rgba(255,209,122,.14), transparent 62%);
  filter: drop-shadow(0 0 18px rgba(255,209,122,.38));
}
body.fire1 .fireRing,
body.fire2 .fireRing,
body.fire3 .fireRing,
body.fire4 .fireRing{
  opacity:1;
  animation: firePulse 0.85s ease-in-out infinite;
}
body.fire3 .fireRing{animation-duration:.65s;}
body.fire4 .fireRing{animation-duration:.55s;}
@keyframes firePulse{
  0%,100%{filter: drop-shadow(0 0 28px var(--pulse1));}
  50%{filter: drop-shadow(0 0 58px var(--pulse2));}
}

/* ===========================
   REMINDER: FIRE BANNER — stop “toast behavior” and make it persistent
   (Edit these existing lines inside .fireBanner)
   =========================== */
.fireBanner{
  /* change from "only shows briefly" to "stays when JS toggles show" */
  pointer-events:none;

  /* keep it visible-friendly */
  opacity:0;
  transform: translateX(-50%) translateY(0);
  transition: opacity .18s ease, transform .18s ease;
}

/* keep .show as the ON state */
.fireBanner.show{
  opacity:1;
  transform: translateX(-50%) translateY(0);
}

@keyframes fireIn{
  from{transform: translateX(-50%) translateY(-10px) scale(.985); opacity:0;}
  to{transform: translateX(-50%) translateY(0) scale(1); opacity:1;}
}

/* readable motion (kids can read) */
.fireBanner.show .en,
.fireBanner.show .jp{
  animation: floatRead 1.8s ease-in-out infinite;
}
@keyframes floatRead{
  0%{transform: translateY(0)}
  50%{transform: translateY(-3px)}
  100%{transform: translateY(0)}
}

.fireBanner .en{
  font-family:'Cinzel',serif;
  font-weight:900;
  letter-spacing:.4px;
  font-size: clamp(18px, 3.1vw, 28px);
  line-height:1.05;
  position:relative;
  z-index:2;
  text-shadow: 0 2px 0 rgba(0,0,0,.25);
}
.fireBanner .jp{
  margin-top:6px;
  font-family:'Noto Sans JP',sans-serif;
  font-weight:900;
  font-size: clamp(14px, 2.7vw, 20px);
  line-height:1.05;
  opacity:.98;
  position:relative;
  z-index:2;
  text-shadow:
    0 2px 0 rgba(0,0,0,.90),
    0 0 10px rgba(0,0,0,.75),
    0 0 18px rgba(0,0,0,.55);
}

/* decorative dot stays but toned */
.fireDot{
  width:14px;height:14px;border-radius:999px;
  background: radial-gradient(circle at 30% 30%, #fff6d8, #ffd17a 45%, #ff6b3d 100%);
  box-shadow: 0 0 26px rgba(255,209,122,.80);
}

/* Banner level looks (you will toggle .fire1/.fire2/.fire3/.fire4 on fireBanner) */
.fireBanner.fire1{
  background: radial-gradient(120% 140% at 20% 20%, rgba(255,214,102,.92), rgba(255,120,90,.45) 55%, rgba(20,30,60,.12) 100%);
  border-color: rgba(255,214,102,.58);
  box-shadow: 0 18px 64px rgba(0,0,0,.55), 0 0 40px rgba(255,214,102,.26);
}
.fireBanner.fire1 .en{ filter: drop-shadow(0 0 10px rgba(255,214,102,.55)); }
.fireBanner.fire1 .jp{ filter: drop-shadow(0 0 10px rgba(255,214,102,.45)); }

.fireBanner.fire2{
  background: radial-gradient(120% 140% at 20% 20%, rgba(255,90,160,.92), rgba(255,214,102,.50) 55%, rgba(20,30,60,.12) 100%);
  border-color: rgba(255,90,160,.58);
  box-shadow: 0 18px 70px rgba(0,0,0,.55), 0 0 48px rgba(255,90,160,.26);
}
.fireBanner.fire2 .en{ filter: drop-shadow(0 0 12px rgba(255,90,160,.55)); }
.fireBanner.fire2 .jp{ filter: drop-shadow(0 0 12px rgba(255,214,102,.45)); }

.fireBanner.fire3{
  background: radial-gradient(120% 140% at 20% 20%, rgba(90,255,214,.92), rgba(120,130,255,.52) 55%, rgba(20,30,60,.12) 100%);
  border-color: rgba(90,255,214,.58);
  box-shadow: 0 18px 78px rgba(0,0,0,.55), 0 0 56px rgba(90,255,214,.26);
}
.fireBanner.fire3 .en{ filter: drop-shadow(0 0 14px rgba(90,255,214,.55)); }
.fireBanner.fire3 .jp{ filter: drop-shadow(0 0 14px rgba(120,130,255,.45)); }

/* ===========================
   REMINDER: LEVEL 4 BANNER — make it feel like a concert screen (EDIT)
   Replace your existing .fireBanner.fire4 with this
   =========================== */
.fireBanner.fire4{
  border-color: rgba(255,255,255,.38);
  background:
    radial-gradient(120% 160% at 15% 20%,
      rgba(255,255,255,.92),
      rgba(255,214,102,.62) 22%,
      rgba(255,90,160,.58) 48%,
      rgba(90,255,214,.58) 70%,
      rgba(120,130,255,.48) 100%
    );
  box-shadow:
    0 24px 140px rgba(255,255,255,.18),
    0 0 70px rgba(255,214,102,.26),
    0 0 70px rgba(255,90,160,.22),
    0 0 70px rgba(90,255,214,.22);

  /* tiny “screen vibe” */
  border-radius: 20px;
}

.fireBanner.fire4::before{
  content:"";
  position:absolute; inset:-45%;
  background:
    conic-gradient(from 0deg,
      rgba(255,214,102,0),
      rgba(255,214,102,.34),
      rgba(255,90,160,.30),
      rgba(90,255,214,.30),
      rgba(120,130,255,.26),
      rgba(255,214,102,.34),
      rgba(255,214,102,0)
    );
  filter: blur(12px);
  opacity: .70;
  animation: wildSpin 1.2s linear infinite;
  z-index: 0;
}

.fireBanner.fire4 .en,
.fireBanner.fire4 .jp{
  animation: floatRead 1.6s ease-in-out infinite, glowPulse 1.1s ease-in-out infinite;
}
@keyframes glowPulse{
  0%{ text-shadow: 0 2px 0 rgba(0,0,0,.25), 0 0 10px rgba(255,255,255,.34); }
  50%{ text-shadow: 0 2px 0 rgba(0,0,0,.25), 0 0 18px rgba(255,255,255,.62); }
  100%{ text-shadow: 0 2px 0 rgba(0,0,0,.25), 0 0 10px rgba(255,255,255,.34); }
}

/* ========================= */

.fx{position:fixed; inset:0; pointer-events:none; z-index:60;}

.heartSvg{
  position:absolute;
  left:50%;
  top:50%;
  width:160px;
  height:160px;
  transform: translate(-50%,-50%) scale(.75);
  opacity:0;
  filter: drop-shadow(0 0 18px rgba(255,209,122,.35));
}
.heartSvg.show{opacity:1; animation: popHeart .65s ease-out forwards;}
@keyframes popHeart{
  0%{transform: translate(-50%,-50%) scale(.55); opacity:0}
  35%{transform: translate(-50%,-55%) scale(1.08); opacity:1}
  70%{transform: translate(-50%,-62%) scale(.98); opacity:.95}
  100%{transform: translate(-50%,-72%) scale(.92); opacity:0}
}

.fart{
  position:absolute;
  left:50%;
  top:50%;
  transform: translate(-50%,-50%) scale(.9);
  width:220px;
  height:160px;
  opacity:0;
}
.fart .blob{
  position:absolute;
  inset:0;
  border-radius: 999px;
  background:
    radial-gradient(circle at 30% 30%, rgba(255,255,255,.92), rgba(203,213,225,.92) 38%, rgba(148,163,184,.95) 100%);
  filter: drop-shadow(0 0 18px rgba(0,0,0,.35));
}
.fart .puff{
  position:absolute;
  width:84px;height:84px;border-radius:999px;
  background:
    radial-gradient(circle at 30% 30%, rgba(255,255,255,.92), rgba(203,213,225,.92) 44%, rgba(148,163,184,.95) 100%);
  filter: drop-shadow(0 0 18px rgba(0,0,0,.35));
}
.fart .p1{left:-18px; top:54px}
.fart .p2{right:-22px; top:62px}
.fart .p3{left:48px; top:-18px; width:92px;height:92px}
.fart .txt{
  position:absolute;
  left:50%;
  top:50%;
  transform: translate(-50%,-50%);
  font-family:'Cinzel',serif;
  font-weight:900;
  letter-spacing:.6px;
  font-size:18px;
  color: rgba(11,16,32,.75);
}
.fart.show{opacity:1; animation: popFart .75s ease-out forwards;}
@keyframes popFart{
  0%{transform: translate(-50%,-50%) scale(.7); opacity:0}
  25%{transform: translate(-50%,-52%) scale(1.03); opacity:1}
  65%{transform: translate(-50%,-58%) scale(.98); opacity:.95}
  100%{transform: translate(-50%,-68%) scale(.92); opacity:0}
}

.results{
  display:none;
  width:min(980px, 100%);
  border-radius:var(--radius);
  background: rgba(15,23,42,.78);
  border:1px solid rgba(255,255,255,.18);
  box-shadow: var(--shadow);
  padding:22px 18px;
  text-align:center;
}
.results.show{display:block}
.results h2{margin:0 0 10px; font-size: clamp(22px, 3vw, 34px)}
.results .sub{font-family:'Noto Sans JP',sans-serif; color:var(--muted); font-weight:800; margin-bottom:14px}
.results .score{font-size: clamp(32px, 4.2vw, 56px); font-weight:900; letter-spacing:.3px}

.btnRow{display:flex; gap:10px; justify-content:center; margin-top:14px; flex-wrap:wrap}
.bigBtn{
  appearance:none;
  border:0;
  border-radius:999px;
  padding:12px 18px;
  font-family:'Cinzel',serif;
  font-weight:900;
  letter-spacing:.4px;
  cursor:pointer;
  background: rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.18);
  color:#fff;
  box-shadow: 0 12px 28px rgba(0,0,0,.35);
}
.bigBtn span{font-family:'Noto Sans JP',sans-serif; font-weight:900; font-size:12px; margin-left:10px; opacity:.95}

.footer{
  text-align:center;
  font-family:'Cinzel',serif;
  font-weight:900;
  letter-spacing:.5px;
  color: rgba(255,255,255,.85);
  font-size: 14px;
  padding: 4px 0 0;
}

/* Next button overlay (shown only after WRONG) */
.nextWrap{
  width:min(980px, 100%);
  display:none;
  justify-content:center;
  margin-top:2px;
}
.nextWrap.show{display:flex}
.nextBtn{
  appearance:none;
  border:0;
  border-radius:999px;
  padding:14px 22px;
  font-family:'Cinzel',serif;
  font-weight:900;
  letter-spacing:.5px;
  cursor:pointer;
  color:#0b1020;
  background: rgba(255,209,122,.95);
  border:1px solid rgba(255,209,122,.85);
  box-shadow:
    0 16px 40px rgba(0,0,0,.45),
    0 0 70px rgba(255,120,70,.28);
  display:flex;
  align-items:baseline;
  gap:10px;
}
.nextBtn .jp{
  font-family:'Noto Sans JP',sans-serif;
  font-weight:900;
  font-size:14px;
  color:#0b1020;
  text-shadow:none;
}

/* Reduce motion */
@media (prefers-reduced-motion: reduce){
  body::before, body::after{animation:none !important}
  .choice,.heartSvg,.fart,.fireRing,.card{animation:none !important; transition:none !important}
  .choice:hover{transform:none}
  .fireBanner.show .en,
  .fireBanner.show .jp{animation:none !important}
}
</style>
</head>


<body>
  <div class="wrap">
    <div class="topbar">
      <button class="back" id="backBtn" aria-label="Back to menu">
        <span aria-hidden="true">←</span> MENU <span class="jp">メニュー</span>
      </button>
      <div class="hud">
        <div class="pill">Q <b id="qNum">1</b>/<span id="qTotal">15</span></div>
        <div class="pill">Score <b id="score">0</b></div>
        <div class="pill">Streak <b id="streak">0</b></div>
      </div>
    </div>

    <div class="stage">
      <div class="card" id="card">
        <div class="fireRing" aria-hidden="true"></div>
        <div class="prompt" id="prompt">
          <div class="jp" id="jpText">—</div>
          <div class="hira" id="hiText">—</div>
        </div>
      </div>

      <div class="grid" id="grid"></div>

      <div class="nextWrap" id="nextWrap">
        <button class="nextBtn" id="nextBtn">NEXT <span class="jp">つぎ</span></button>
      </div>

      <div class="results" id="results">
        <h2>Finished!</h2>
        <div class="sub">おつかれさま！</div>
        <div class="score"><span id="finalScore">0</span>/<span id="finalTotal">0</span></div>
        <div class="btnRow">
          <button class="bigBtn" id="playAgain">PLAY AGAIN <span>もういちど</span></button>
          <button class="bigBtn" id="back2">BACK TO MENU <span>メニュー</span></button>
        </div>
      </div>
    </div>

    <div class="footer">Bryan’s English School</div>
  </div>

 <!-- =========================
     REMINDER: FIRE BANNER — make it a persistent LEVEL HUD
     - Keep it as one container
     - Add a background “layer” for level 4 concert vibes (beams/shimmer)
     - Keep text readable (text stays on top)
     ========================= -->
<div class="fireBanner" id="fireBanner" role="status" aria-live="polite">
  <div class="bannerFX" aria-hidden="true"></div> <!-- ✅ ADD (visual layer; CSS animates it) -->

  <span class="fireDot" aria-hidden="true"></span>
  <div class="en" id="fireEn">You’re on fire!</div>
  <div class="jp" id="fireJp">ノってきた！</div>
</div>


  <div class="fx" id="fx">
    <svg class="heartSvg" id="heart" viewBox="0 0 64 64" aria-hidden="true">
      <defs>
        <radialGradient id="hg" cx="30%" cy="25%" r="80%">
          <stop offset="0%" stop-color="rgba(255,255,255,.98)"/>
          <stop offset="45%" stop-color="rgba(255,209,122,.98)"/>
          <stop offset="100%" stop-color="rgba(255,126,185,.98)"/>
        </radialGradient>
      </defs>
      <path fill="url(#hg)" d="M32 56s-20-12.6-26.8-25C-.3 18.6 8 8.6 19.5 12.2c5 1.6 8.2 6.2 12.5 11 4.3-4.8 7.5-9.4 12.5-11C56 8.6 64.3 18.6 58.8 31 52 43.4 32 56 32 56z"/>
    </svg>

    <div class="fart" id="fart">
      <div class="blob"></div>
      <div class="puff p1"></div>
      <div class="puff p2"></div>
      <div class="puff p3"></div>
      <div class="txt">NO!</div>
    </div>
  </div>

<script>
/* =========================
   Booha Review – Pick the Sentence (January)
   UPDATES:
   ✅ JP text: stronger black glow
   ✅ Wrong answer: NO "✓ CORRECT" pill; correct answer glows green; student clicks NEXT
   ✅ Fire level 3: keep JP/Hira text from moving (card can still wobble)
   ========================= */

/* ---------- WebAudio SFX (same-folder) ---------- */
const SFX = (() => {
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let ctx = null;
  let master = null;
  const buf = new Map();
  let unlocked = false;

  function ensure(){
    if (!ctx) {
      ctx = new AudioCtx();
      master = ctx.createGain();
      master.gain.value = 1;
      master.connect(ctx.destination);
    }
  }

 /* =========================
   REMINDER: PRELOAD ERROR VISIBILITY (OPTIONAL, DEBUG ONLY)
   - Helps you catch 404s or decode errors for level4.mp3
   ========================= */
async function loadOne(name, url){
  ensure();
  const res = await fetch(url, { cache: "force-cache" });
  if(!res.ok) throw new Error(`SFX fetch failed: ${name} -> ${url} (${res.status})`); // ✅ optional debug
  const arr = await res.arrayBuffer();
  const b = await ctx.decodeAudioData(arr);
  buf.set(name, b);
}


  /* =========================
   REMINDER: PRELOAD level4.mp3 (ADD THIS SOUND)
   - Add one more loadOne line inside preload()
   ========================= */
async function preload(){
  ensure();
  await Promise.all([
    loadOne("ding", "ding.mp3"),
    loadOne("fart", "fart.mp3"),
    loadOne("fire", "fire.mp3"),
    loadOne("level4", "level4.mp3"), // ✅ ADD
  ]);
}


  function unlock(){
    ensure();
    if (unlocked) return;
    unlocked = true;

    if (ctx.state === "suspended") ctx.resume().catch(()=>{});
    const b = ctx.createBuffer(1, 1, 22050);
    const src = ctx.createBufferSource();
    src.buffer = b;
    src.connect(master);
    try { src.start(0); } catch(e) {}
  }

  /* =========================
   REMINDER: PLAY SAFETY FALLBACK (OPTIONAL)
   - If level4 fails to decode/load, it will be silent.
   - This fallback tries "fire" so there’s always feedback.
   ========================= */
function play(name, volume=1){
  if (!ctx) return;
  let b = buf.get(name);

  // ✅ OPTIONAL fallback so it's never silent
  if (!b && name === "level4") b = buf.get("fire");
  if (!b) return;

  if (ctx.state === "suspended") ctx.resume().catch(()=>{});

  const src = ctx.createBufferSource();
  src.buffer = b;

  const g = ctx.createGain();
  g.gain.value = Math.max(0, Math.min(1, volume));

  src.connect(g);
  g.connect(master);

  try { src.start(0); } catch(e) {}
}


  return { preload, unlock, play };
})();

/* ---------- DATA ---------- */
const DATA = [
  { jp:"私は毎日勉強します。", hira:"わたし は まいにち べんきょう します。", choices:[
    "I will study every day.",
    "I study will every day.",
    "I will studying every day.",
    "I will study everyday."
  ], correct:0 },

  { jp:"今年、私はベストを尽くします。", hira:"ことし、わたし は べすと を つくします。", choices:[
    "I will do my best this year.",
    "I do my best will this year.",
    "I will doing my best this year.",
    "I am do my best this year."
  ], correct:0 },

  { jp:"私は新しい友だちを作ります。", hira:"わたし は あたらしい ともだち を つくります。", choices:[
    "I will make a new friend.",
    "I will made a new friend.",
    "I make will a new friend.",
    "I will making a new friend."
  ], correct:0 },

  { jp:"私はもう遅刻しません。", hira:"わたし は もう ちこく しません。", choices:[
    "I will not be late anymore.",
    "I will not late anymore.",
    "I not will be late anymore.",
    "I will don't be late anymore."
  ], correct:0 },

  { jp:"私はもっと英語を話します。", hira:"わたし は もっと えいご を はなします。", choices:[
    "I will speak more English.",
    "I speak will more English.",
    "I will speaking more English.",
    "I will speak English more."
  ], correct:0 },

  { jp:"私は７時に起きます。", hira:"わたし は しちじ に おきます。", choices:[
    "I wake up at seven.",
    "I wakes up at seven.",
    "I wake at up seven.",
    "I am wake up at seven."
  ], correct:0 },

  { jp:"私は毎日朝ごはんを食べます。", hira:"わたし は まいにち あさごはん を たべます。", choices:[
    "I eat breakfast every day.",
    "I eats breakfast every day.",
    "I eat breakfast everyday.",
    "I am eat breakfast every day."
  ], correct:0 },

  { jp:"私は８時に学校へ行きます。", hira:"わたし は はちじ に がっこう へ いきます。", choices:[
    "I go to school at eight.",
    "I goes to school at eight.",
    "I go school to at eight.",
    "I am go to school at eight."
  ], correct:0 },

  { jp:"私は寝る前に宿題をします。", hira:"わたし は ねる まえ に しゅくだい を します。", choices:[
    "I do my homework before bed.",
    "I do my homework before the bed.",
    "I am do my homework before bed.",
    "I do homework my before bed."
  ], correct:0 },

  { jp:"私は毎日学校へ歩いて行きます。", hira:"わたし は まいにち がっこう へ あるいて いきます。", choices:[
    "I walk to school every day.",
    "I walks to school every day.",
    "I walk school to every day.",
    "I am walk to school every day."
  ], correct:0 },

  { jp:"朝ごはんを食べたほうがいいです。", hira:"あさごはん を たべた ほう が いい です。", choices:[
    "You should eat breakfast.",
    "You should to eat breakfast.",
    "You should eating breakfast.",
    "You eat breakfast should."
  ], correct:0 },

  { jp:"手を洗わなければなりません。", hira:"て を あらわ なければ なりません。", choices:[
    "You must wash your hands.",
    "You must to wash your hands.",
    "You wash your hands must.",
    "You must washing your hands."
  ], correct:0 },

  { jp:"ノートを持ってこなければなりません。", hira:"のーと を もってこ なければ なりません。", choices:[
    "You have to bring your notebook.",
    "You have bring to your notebook.",
    "You must bringing your notebook.",
    "You have to brought your notebook."
  ], correct:0 },

  { jp:"疲れたときは休んだほうがいいです。", hira:"つかれた とき は やすんだ ほう が いい です。", choices:[
    "You should rest when you're tired.",
    "You should resting when you're tired.",
    "You should rest when you tired.",
    "You rest should when you're tired."
  ], correct:0 },

  { jp:"ほかの人に親切にしなければなりません。", hira:"ほか の ひと に しんせつ に しなければ なりません。", choices:[
    "You must be kind to others.",
    "You must kind to others.",
    "You must being kind to others.",
    "You are must kind to others."
  ], correct:0 },

  { jp:"私は英語を学びたいです。", hira:"わたし は えいご を まなびたい です。", choices:[
    "I want to learn English.",
    "I want learn English.",
    "I want learning English.",
    "I want to learning English."
  ], correct:0 },

  { jp:"私はもっとがんばりたいです。", hira:"わたし は もっと がんばりたい です。", choices:[
    "I want to try harder.",
    "I want try harder.",
    "I want to trying harder.",
    "I try want harder."
  ], correct:0 },

  { jp:"私はもっと本を読みたいです。", hira:"わたし は もっと ほん を よみたい です。", choices:[
    "I want to read more books.",
    "I want read more books.",
    "I want reading more books.",
    "I want to read books more."
  ], correct:0 },

  { jp:"私は新しい友だちを作りたいです。", hira:"わたし は あたらしい ともだち を つくりたい です。", choices:[
    "I want to make new friends.",
    "I want make new friends.",
    "I want to making new friends.",
    "I want make friends new."
  ], correct:0 },

  { jp:"私はベストを尽くすことができます。", hira:"わたし は べすと を つくす こと が できます。", choices:[
    "I can do my best.",
    "I can to do my best.",
    "I do can my best.",
    "I can doing my best."
  ], correct:0 },

  { jp:"私は少し英語を話せます。", hira:"わたし は すこし えいご を はなせます。", choices:[
    "I can speak a little English.",
    "I can speak little English.",
    "I can to speak a little English.",
    "I speak can a little English."
  ], correct:0 },

  { jp:"私は英語の歌を理解できます。", hira:"わたし は えいご の うた を りかい できます。", choices:[
    "I can understand songs in English.",
    "I can understand English songs in.",
    "I understand can songs in English.",
    "I can understanding songs in English."
  ], correct:0 },

  { jp:"私はクラスメートを手伝えます。", hira:"わたし は くらすめーと を てつだえます。", choices:[
    "I can help my classmates.",
    "I can to help my classmates.",
    "I help can my classmates.",
    "I can helping my classmates."
  ], correct:0 },

  { jp:"私は絵を描くのが得意です。", hira:"わたし は え を かく の が とくい です。", choices:[
    "I'm good at drawing.",
    "I'm good drawing.",
    "I good at drawing.",
    "I'm good at draw."
  ], correct:0 },

  { jp:"私は聞くことが得意です。", hira:"わたし は きく こと が とくい です。", choices:[
    "I'm good at listening.",
    "I'm good listening.",
    "I good at listening.",
    "I'm good at listen."
  ], correct:0 },

  { jp:"私は数学が得意ではありません。", hira:"わたし は すうがく が とくい では ありません。", choices:[
    "I'm not good at math.",
    "I'm not good in math.",
    "I not good at math.",
    "I'm not good to math."
  ], correct:0 },

  { jp:"私は名前を覚えるのが得意です。", hira:"わたし は なまえ を おぼえる の が とくい です。", choices:[
    "I'm good at remembering names.",
    "I'm good remembering names.",
    "I'm good at remember names.",
    "I good at remembering names."
  ], correct:0 },

  { jp:"私は人を元気づけるのが得意です。", hira:"わたし は ひと を げんきづける の が とくい です。", choices:[
    "I'm good at cheering people up.",
    "I'm good cheering people up.",
    "I'm good at cheer people up.",
    "I good at cheering people up."
  ], correct:0 },

  { jp:"私は失敗から学ぶことができます。", hira:"わたし は しっぱい から まなぶ こと が できます。", choices:[
    "I can learn from mistakes.",
    "I can learn of mistakes.",
    "I learn can from mistakes.",
    "I can learning from mistakes."
  ], correct:0 },

  { jp:"私は前向きでいられます。", hira:"わたし は まえむき で いられます。", choices:[
    "I can stay positive.",
    "I can stay positivity.",
    "I stay can positive.",
    "I can staying positive."
  ], correct:0 },

  { jp:"私は新しいことに挑戦するつもりです。", hira:"わたし は あたらしい こと に ちょうせん する つもり です。", choices:[
    "I'm going to try something new.",
    "I'm going try something new.",
    "I going to try something new.",
    "I'm going to trying something new."
  ], correct:0 },

  { jp:"私はクラスメートを手伝います。", hira:"わたし は くらすめーと を てつだいます。", choices:[
    "I will help my classmates.",
    "I will helps my classmates.",
    "I help will my classmates.",
    "I will helping my classmates."
  ], correct:0 },

  { jp:"私は今日、机を掃除します。", hira:"わたし は きょう つくえ を そうじ します。", choices:[
    "I will clean my desk today.",
    "I will cleaning my desk today.",
    "I clean will my desk today.",
    "I will clean my desk in today."
  ], correct:0 },

  { jp:"私はもっと本を読みます。", hira:"わたし は もっと ほん を よみます。", choices:[
    "I will read more books.",
    "I will reading more books.",
    "I read will more books.",
    "I will read books more."
  ], correct:0 },

  { jp:"私は良い習慣を始めます。", hira:"わたし は いい しゅうかん を はじめます。", choices:[
    "I will start a good habit.",
    "I will start good habit.",
    "I will starting a good habit.",
    "I start will a good habit."
  ], correct:0 },

  { jp:"私は毎週、日記を書きます。", hira:"わたし は まいしゅう にっき を かきます。", choices:[
    "I will write in my diary every week.",
    "I will write my diary every week.",
    "I will writing in my diary every week.",
    "I write will in my diary every week."
  ], correct:0 },

  { jp:"私はもっと早く起きます。", hira:"わたし は もっと はやく おきます。", choices:[
    "I will wake up earlier.",
    "I will wake earlier.",
    "I will waking up earlier.",
    "I wake will up earlier."
  ], correct:0 },

  { jp:"私は授業でよく聞きます。", hira:"わたし は じゅぎょう で よく ききます。", choices:[
    "I will listen carefully in class.",
    "I will listen careful in class.",
    "I will listening carefully in class.",
    "I listen will carefully in class."
  ], correct:0 },

  { jp:"私はもっと笑います。", hira:"わたし は もっと わらいます。", choices:[
    "I will smile more.",
    "I will smiling more.",
    "I smile will more.",
    "I will smile many."
  ], correct:0 },

  { jp:"私は学ぶことを楽しみます。", hira:"わたし は まなぶ こと を たのしみます。", choices:[
    "I will enjoy learning.",
    "I will enjoying learning.",
    "I enjoy will learning.",
    "I will enjoy to learn."
  ], correct:0 },

  { jp:"私は朝にシャワーを浴びます。", hira:"わたし は あさ に しゃわー を あびます。", choices:[
    "I take a shower in the morning.",
    "I takes a shower in the morning.",
    "I take a shower at the morning.",
    "I am take a shower in the morning."
  ], correct:0 },

  { jp:"私は食事のあとに歯をみがきます。", hira:"わたし は しょくじ の あと に は を みがきます。", choices:[
    "I brush my teeth after meals.",
    "I brushes my teeth after meals.",
    "I brush my teeth after meal.",
    "I am brush my teeth after meals."
  ], correct:0 },

  { jp:"私は夕食のあとに英語を勉強します。", hira:"わたし は ゆうしょく の あと に えいご を べんきょう します。", choices:[
    "I study English after dinner.",
    "I studies English after dinner.",
    "I study English after the dinner.",
    "I am study English after dinner."
  ], correct:0 },

  { jp:"私は夕方に家族を手伝います。", hira:"わたし は ゆうがた に かぞく を てつだいます。", choices:[
    "I help my family in the evening.",
    "I helps my family in the evening.",
    "I help my family on the evening.",
    "I am help my family in the evening."
  ], correct:0 },

  { jp:"私は毎週日曜日に部屋を掃除します。", hira:"わたし は まいしゅう にちようび に へや を そうじ します。", choices:[
    "I clean my room every Sunday.",
    "I cleans my room every Sunday.",
    "I clean my room in every Sunday.",
    "I am clean my room every Sunday."
  ], correct:0 },

  { jp:"私は１０時に寝ます。", hira:"わたし は じゅうじ に ねます。", choices:[
    "I sleep at ten o'clock.",
    "I sleeps at ten o'clock.",
    "I sleep in ten o'clock.",
    "I am sleep at ten o'clock."
  ], correct:0 },

  { jp:"私はときどき夜に読みます。", hira:"わたし は ときどき よる に よみます。", choices:[
    "I sometimes read at night.",
    "I sometime read at night.",
    "I sometimes reads at night.",
    "I am sometimes read at night."
  ], correct:0 },

  { jp:"私は学校の前にテレビを決して見ません。", hira:"わたし は がっこう の まえ に てれび を けっして みません。", choices:[
    "I never watch TV before school.",
    "I never watches TV before school.",
    "I don't never watch TV before school.",
    "I never watch TV before the school."
  ], correct:0 },

  { jp:"私はたいてい友だちと昼ごはんを食べます。", hira:"わたし は たいてい ともだち と ひるごはん を たべます。", choices:[
    "I usually eat lunch with friends.",
    "I usually eats lunch with friends.",
    "I eat usually lunch with friends.",
    "I am usually eat lunch with friends."
  ], correct:0 },

  { jp:"私は授業のあとにリラックスします。", hira:"わたし は じゅぎょう の あと に りらっくす します。", choices:[
    "I relax after class.",
    "I relaxes after class.",
    "I am relax after class.",
    "I relax after the class."
  ], correct:0 }
];

/* ---------- Hooks ---------- */
const grid       = document.querySelector("#grid");
const jpText     = document.querySelector("#jpText");
const hiText     = document.querySelector("#hiText");
const qNum       = document.querySelector("#qNum");
const qTotal     = document.querySelector("#qTotal");
const scoreEl    = document.querySelector("#score");
const streakEl   = document.querySelector("#streak");
const results    = document.querySelector("#results");
const finalScore = document.querySelector("#finalScore");
const finalTotal = document.querySelector("#finalTotal");

const fireBanner = document.querySelector("#fireBanner");
const fireEn     = document.querySelector("#fireEn");
const fireJp     = document.querySelector("#fireJp");

const heart      = document.querySelector("#heart");
const fart       = document.querySelector("#fart");

const backBtn    = document.querySelector("#backBtn");
const back2      = document.querySelector("#back2");
const playAgain  = document.querySelector("#playAgain");

const nextWrap   = document.querySelector("#nextWrap");
const nextBtn    = document.querySelector("#nextBtn");

const card       = document.querySelector("#card");
const prompt     = document.querySelector("#prompt");

/* ---------- State ---------- */
let order = [];
let idx = 0;
let score = 0;
let streak = 0;
let locked = false;
let bannerTimer = null;
let pendingAdvance = false;
let lastFireLevel = 0;   // ✅ NEW: prevents banner/sound spam

/* ---------- Shuffle ---------- */
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

/* ---------- Fire level thresholds ---------- */
function getFireLevelFromStreak(n){
  if(n >= 15) return 4;  // ✅ NEW
  if(n >= 10) return 3;
  if(n >= 6)  return 2;
  if(n >= 3)  return 1;
  return 0;
}

/* ---------- Fire level (BODY) ---------- */
function setFireLevelFromStreak(){
  const lv = getFireLevelFromStreak(streak);
  document.body.classList.remove("fire1","fire2","fire3","fire4");
  if(lv) document.body.classList.add(`fire${lv}`);
}

/* ---------- FX ---------- */
function popHeart(){
  heart.classList.remove("show");
  void heart.getBoundingClientRect();
  heart.classList.add("show");
}
function popFart(){
  fart.classList.remove("show");
  void fart.getBoundingClientRect();
  fart.classList.add("show");
}

/* ---------- Fire Banner (EN/JP + brighter levels + NEW level 4) ---------- */
const FIRE_MSG = {
  1: { en:"You are awesome!",                 jp:"すごい！" },
  2: { en:"You are even more awesome!",       jp:"もっとすごい！" },
  3: { en:"What? You are the most awesome!",  jp:"えっ！？一番すごい！" },
  4: { en:"You are the smartest person alive!!!", jp:"あなたは世界一かしこい！！！" }
};

function playLevelSound(lv){
  // ✅ Keep your existing sound system. We only add level4.mp3.
  // If you already have SFX registered as "level1/2/3", add "level4" there too.
  if(lv === 1 || lv === 2 || lv === 3){
    SFX.play("fire", 1); // keep same sound behavior you already had
    return;
  }
  if(lv === 4){
    // NEW: level4.mp3 should be preloaded like the others
    // Make sure SFX has it:
    // SFX.add("level4","assets/audio/level4.mp3") (or your existing method)
    try{ SFX.play("level4", 1); }catch(e){ SFX.play("fire", 1); }
  }
}

/* =========================
   REMINDER: FIRE BANNER PERSISTENCE
   - Remove the timeout so banner stays ON during the level
   - Banner will hide only when level becomes 0 elsewhere
   ========================= */
function showFireBanner(level){
  const msg = FIRE_MSG[level];
  if(!msg) return;

  fireEn.textContent = msg.en;
  fireJp.textContent = msg.jp;

  // ✅ banner gets class fire1..fire4 (for color/excitement)
  fireBanner.classList.remove("fire1","fire2","fire3","fire4");
  fireBanner.classList.add(`fire${level}`);

  /* =========================
   REMINDER: FIRE BANNER OFF WHEN STREAK = 0
   ========================= */
// when level becomes 0:
fireBanner.classList.remove("show","fire1","fire2","fire3","fire4");


  // ✅ NO timeout anymore (persistent)
  clearTimeout(bannerTimer);
  bannerTimer = null;
}


  playLevelSound(level);
}

/* Call this after streak changes */
function maybeTriggerFire(streakNow){
  const lv = getFireLevelFromStreak(streakNow);

  // only trigger when leveling up
  if(lv > lastFireLevel){
    showFireBanner(lv);
    lastFireLevel = lv;
  }
  if(lv === 0) lastFireLevel = 0;
}

/* ---------- Game ---------- */
function resetGame(){
  order = shuffle([...Array(DATA.length)].map((_,i)=>i));
  idx = 0;
  score = 0;
  streak = 0;
  locked = false;
  pendingAdvance = false;
  lastFireLevel = 0;

  document.body.classList.remove("fire1","fire2","fire3","fire4");
  fireBanner.classList.remove("show","fire1","fire2","fire3","fire4");
  clearTimeout(bannerTimer);

  qTotal.textContent = String(DATA.length);
  finalTotal.textContent = String(DATA.length);
}

function render(){
  locked = false;
  pendingAdvance = false;
  nextWrap.classList.remove("show");

  grid.innerHTML = "";
  results.classList.remove("show");

  const item = DATA[order[idx]];
  qNum.textContent = String(idx+1);
  jpText.textContent = item.jp;
  hiText.textContent = item.hira;

  const mixed = shuffle(item.choices.map((t, i)=>({t, i})));

  mixed.forEach((c)=>{
    const btn = document.createElement("div");
    btn.className = "choice";
    btn.innerHTML = `<div class="en">${c.t}</div>`;
    btn.addEventListener("click", ()=>pick(btn, c.i));
    grid.appendChild(btn);
  });

  scoreEl.textContent = String(score);
  streakEl.textContent = String(streak);
  setFireLevelFromStreak();
}

function advance(){
  idx++;
  if(idx >= order.length){
    results.classList.add("show");
    finalScore.textContent = String(score);
    grid.innerHTML = "";
    jpText.textContent = "—";
    hiText.textContent = "—";
    nextWrap.classList.remove("show");
    locked = true;
    return;
  }
  render();
}

function pick(tile, originalIndex){
  if(locked || pendingAdvance) return;
  locked = true;

  const item = DATA[order[idx]];
  const tiles = [...document.querySelectorAll(".choice")];
  tiles.forEach(t=>t.classList.add("locked"));

  const isCorrect = (originalIndex === item.correct);

  if(isCorrect) SFX.play("ding", 1);
  else SFX.play("fart", 1);

  if(isCorrect){
    tile.classList.add("correct");
    score++;
    streak++;
    popHeart();

    // ✅ NEW: fire logic centralized + includes level 4 at 15
    maybeTriggerFire(streak);

    scoreEl.textContent = String(score);
    streakEl.textContent = String(streak);
    setFireLevelFromStreak();

    setTimeout(advance, 650);

  }else{
    tile.classList.add("wrong");
    popFart();
    streak = 0;

    // ✅ Reveal correct tile with GREEN GLOW (no pill)
    const correctText = item.choices[item.correct];
    const correctTile = tiles.find(t=>{
      const el = t.querySelector(".en");
      return el && el.textContent === correctText;
    });
    if(correctTile) correctTile.classList.add("correctGlow");

    scoreEl.textContent = String(score);
    streakEl.textContent = String(streak);
    setFireLevelFromStreak();

    // reset fire state
    lastFireLevel = 0;
    fireBanner.classList.remove("fire1","fire2","fire3","fire4");

    pendingAdvance = true;
    nextWrap.classList.add("show");
    locked = false; // allow NEXT button interaction
  }
}

/* ---------- Fire3/4: keep JP text from moving while card animates ---------- */
const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

function parseMatrix2D(t){
  if(!t || t === "none") return null;
  const m = t.match(/matrix\(([^)]+)\)/);
  if(!m) return null;
  const parts = m[1].split(",").map(s=>parseFloat(s.trim()));
  if(parts.length !== 6 || parts.some(n=>Number.isNaN(n))) return null;
  return parts;
}

function invertMatrix2D(m){
  const [a,b,c,d,e,f] = m;
  const det = a*d - b*c;
  if(!det) return null;
  const id = 1/det;
  const na =  d*id;
  const nb = -b*id;
  const nc = -c*id;
  const nd =  a*id;
  const ne = -(na*e + nc*f);
  const nf = -(nb*e + nd*f);
  return [na,nb,nc,nd,ne,nf];
}

let stabilizeRAF = 0;
function stabilizePromptLoop(){
  cancelAnimationFrame(stabilizeRAF);
  if(prefersReduced) { prompt.style.transform = "none"; return; }

  const tick = ()=>{
    const isFire = document.body.classList.contains("fire3") || document.body.classList.contains("fire4");
    if(!isFire){
      prompt.style.transform = "none";
      stabilizeRAF = requestAnimationFrame(tick);
      return;
    }

    const m = parseMatrix2D(getComputedStyle(card).transform);
    if(!m){
      prompt.style.transform = "none";
      stabilizeRAF = requestAnimationFrame(tick);
      return;
    }

    const inv = invertMatrix2D(m);
    if(!inv){
      prompt.style.transform = "none";
      stabilizeRAF = requestAnimationFrame(tick);
      return;
    }

    prompt.style.transform = `matrix(${inv[0]},${inv[1]},${inv[2]},${inv[3]},${inv[4]},${inv[5]})`;
    stabilizeRAF = requestAnimationFrame(tick);
  };

  stabilizeRAF = requestAnimationFrame(tick);
}

/* ---------- Buttons ---------- */
function goMenu(){ history.back(); }
backBtn && backBtn.addEventListener("click", goMenu);
back2 && back2.addEventListener("click", goMenu);

playAgain && playAgain.addEventListener("click", ()=>{
  resetGame();
  render();
});

nextBtn && nextBtn.addEventListener("click", ()=>{
  if(!pendingAdvance) return;
  pendingAdvance = false;
  nextWrap.classList.remove("show");
  advance();
});

/* ---------- Boot ---------- */
(async function boot(){
  try{ await SFX.preload(); }catch(e){}
  resetGame();
  render();
  stabilizePromptLoop();
})();

window.addEventListener("pointerdown", () => { try{ SFX.unlock(); }catch(e){} }, { once:true, passive:true });
window.addEventListener("touchstart", () => { try{ SFX.unlock(); }catch(e){} }, { once:true, passive:true });

</script>
</body>
</html>
