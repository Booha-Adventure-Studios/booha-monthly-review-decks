<!-- =========================
REMINDERS (READ ME)
‚úÖ Put these files in the SAME folder as this HTML:
   - ding.mp3
   - fart.mp3
   - fire.mp3
   - level4.mp3  (required for Fire Level 4)
‚úÖ Keep @keyframes wildSpin defined ONCE (used by card + banner)
‚úÖ Fire levels must exist in BOTH CSS + JS:
   - CSS: body.fire1..body.fire4
   - JS: getFireLevelFromStreak() thresholds 3/6/10/15
‚úÖ g4 rule:
   - ONLY misspelled word OR extra word (duplication)
   - NEVER missing words
‚úÖ Gameplay:
   - Tap the misspelled word OR the extra (duplicated) word
   - Multi-attempt allowed; scoring rewards first-try
========================= -->

<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Booha Review Decks ‚Äì Spot the Mistake</title>
<meta name="theme-color" content="#0b1020" />
<link rel="icon" type="image/png" href="BoohaYellow.png">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Noto+Sans+JP:wght@500;700;900&display=swap" rel="stylesheet" />

<style>
:root{
  --bg:#0b1020;
  --ink:#ffffff;
  --good:#22c55e;
  --bad:#ef4444;
  --gold:#ffd166;
  --outline:rgba(255,255,255,.12);

  /* fire (shared feel) */
  --fireA: rgba(255,209,122,.12);
  --fireB: rgba(255,120,70,.08);
  --ringA: rgba(255,209,122,.22);
  --ringB: rgba(255,120,70,.14);
  --pulse1: rgba(255,209,122,.22);
  --pulse2: rgba(255,120,70,.22);

  --unlockGlow: rgba(255,209,122,.00);
  --unlockScale: 1;
  --unlockWobble: 0deg;

  --bgP: rgba(124,58,237,.46); /* purple */
  --bgB: rgba(94,230,255,.30); /* blue */
  --bgG: rgba(255,209,122,.26); /* gold */

  --stormA: rgba(255,126,185,.00);
  --stormB: rgba(94,230,255,.00);
  --stormC: rgba(255,209,122,.00);
  --fireSpark: 0;

  --hudSize: 14px;
}

*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}

body{
  margin:0;
  background:
    radial-gradient(1200px 760px at 28% 18%, var(--bgP), transparent 58%),
    radial-gradient(980px 720px  at 76% 26%, var(--bgB), transparent 60%),
    radial-gradient(980px 760px  at 52% 92%, var(--bgG), transparent 62%),
    var(--bg);
  color:var(--ink);
  font-family:'Cinzel',serif;
  overflow:hidden;
}

/* aurora overlay */
body::before{
  content:"";
  position:fixed;
  inset:-12%;
  pointer-events:none;
  z-index:0;
  background:
    radial-gradient(900px 650px at 20% 20%, rgba(255,126,185,.24), transparent 60%),
    radial-gradient(900px 650px at 82% 30%, rgba(94,230,255,.20), transparent 62%),
    radial-gradient(900px 650px at 55% 85%, rgba(255,209,122,.20), transparent 62%),
    radial-gradient(900px 650px at 35% 65%, rgba(124,58,237,.22), transparent 62%);
  filter: blur(10px) saturate(1.35);
  opacity:.95;
  mix-blend-mode: screen;
  transform: translate3d(0,0,0);
  animation: auroraDrift 8.5s ease-in-out infinite;
}
@keyframes auroraDrift{
  0%   {transform: translate(-2%, -1%) scale(1.02)}
  50%  {transform: translate( 2%,  1%) scale(1.06)}
  100% {transform: translate(-2%, -1%) scale(1.02)}
}

/* fire storm overlay */
body::after{
  content:"";
  position:fixed;
  inset:-10%;
  pointer-events:none;
  z-index:0;
  background:
    radial-gradient(900px 700px at 30% 18%, var(--stormA), transparent 62%),
    radial-gradient(1000px 760px at 70% 28%, var(--stormB), transparent 62%),
    radial-gradient(980px 760px at 50% 86%, var(--stormC), transparent 62%),
    conic-gradient(from 210deg at 50% 45%,
      rgba(255,209,122, calc(.03 + var(--fireSpark)*.06)),
      rgba(255,120,70,  calc(.02 + var(--fireSpark)*.06)),
      rgba(94,230,255,  calc(.02 + var(--fireSpark)*.06)),
      rgba(124,58,237,  calc(.02 + var(--fireSpark)*.06)),
      rgba(255,126,185, calc(.02 + var(--fireSpark)*.06)),
      rgba(255,209,122, calc(.03 + var(--fireSpark)*.06))
    );
  filter: blur(14px) saturate(1.55) contrast(1.05);
  opacity: .85;
  mix-blend-mode: screen;
  animation: fireStorm 3.2s ease-in-out infinite;
}
@keyframes fireStorm{
  0%   {transform: translate(-1.5%, -1%) rotate(-2deg) scale(1.02)}
  50%  {transform: translate( 1.5%,  1%) rotate( 2deg) scale(1.06)}
  100% {transform: translate(-1.5%, -1%) rotate(-2deg) scale(1.02)}
}

/* ‚úÖ IMPORTANT: define wildSpin ONCE (used by card + banner) */
@keyframes wildSpin{to{transform: rotate(360deg);}}

/* ===========================
   FIRE LEVELS (MATCH g2 + LEVEL 4)
   =========================== */
body.fire1{
  --fireA: rgba(255,209,122,.48);
  --fireB: rgba(255,120,70,.32);
  --ringA: rgba(255,209,122,.72);
  --ringB: rgba(255,120,70,.54);
  --pulse1: rgba(255,209,122,.82);
  --pulse2: rgba(255,120,70,.70);

  --bgP: rgba(124,58,237,.78);
  --bgB: rgba(94,230,255,.56);
  --bgG: rgba(255,209,122,.60);

  --stormA: rgba(255,126,185,.36);
  --stormB: rgba(94,230,255,.32);
  --stormC: rgba(255,209,122,.32);
  --fireSpark: .75;

  --unlockGlow: rgba(255,209,122,.22);
  --unlockScale: 1.00;
  --unlockWobble: 0deg;
}

body.fire2{
  --fireA: rgba(255,209,122,.82);
  --fireB: rgba(255,120,70,.62);
  --ringA: rgba(255,209,122,.98);
  --ringB: rgba(255,120,70,.92);
  --pulse1: rgba(255,209,122,1.00);
  --pulse2: rgba(255,120,70,1.00);

  --bgP: rgba(124,58,237,1.00);
  --bgB: rgba(94,230,255,.78);
  --bgG: rgba(255,209,122,.82);

  --stormA: rgba(255,126,185,.58);
  --stormB: rgba(94,230,255,.50);
  --stormC: rgba(255,209,122,.50);
  --fireSpark: 1.10;

  --unlockGlow: rgba(255,120,70,.28);
  --unlockScale: 1.01;
  --unlockWobble: 0.4deg;
}

body.fire3{
  --fireA: rgba(255,255,255,.18);
  --fireB: rgba(255,209,122,1.00);
  --ringA: rgba(255,255,255,.40);
  --ringB: rgba(255,120,70,1.00);
  --pulse1: rgba(255,255,255,.42);
  --pulse2: rgba(94,230,255,.70);

  --bgP: rgba(255,126,185,.44);
  --bgB: rgba(94,230,255,.62);
  --bgG: rgba(255,209,122,.94);

  --stormA: rgba(255,126,185,.78);
  --stormB: rgba(94,230,255,.68);
  --stormC: rgba(255,209,122,.68);
  --fireSpark: 1.35;

  --unlockGlow: rgba(94,230,255,.30);
  --unlockScale: 1.03;
  --unlockWobble: 0.9deg;
}

body.fire4{
  --fireA: rgba(255,255,255,.28);
  --fireB: rgba(255,214,102,1.00);
  --ringA: rgba(255,255,255,.75);
  --ringB: rgba(255,90,160,1.00);
  --pulse1: rgba(255,255,255,.85);
  --pulse2: rgba(90,255,214,.92);

  --bgP: rgba(255,90,160,.72);
  --bgB: rgba(90,255,214,.62);
  --bgG: rgba(255,214,102,.72);

  --stormA: rgba(255,90,160,.78);
  --stormB: rgba(90,255,214,.70);
  --stormC: rgba(255,214,102,.70);
  --fireSpark: 1.75;

  --unlockGlow: rgba(255,255,255,.22);
  --unlockScale: 1.04;
  --unlockWobble: 1.1deg;
}

/* ensure fire background overlays kick in */
body.fire1, body.fire2, body.fire3, body.fire4{
  background:
    radial-gradient(1100px 760px at 50% 16%, var(--fireA), transparent 60%),
    radial-gradient(980px 720px  at 50% 46%, var(--fireB), transparent 62%),
    radial-gradient(980px 760px  at 50% 92%, rgba(255,209,122,.24), transparent 62%),
    radial-gradient(1200px 760px at 28% 18%, var(--bgP), transparent 58%),
    radial-gradient(980px 720px  at 76% 26%, var(--bgB), transparent 60%),
    radial-gradient(980px 760px  at 52% 92%, var(--bgG), transparent 62%),
    var(--bg);
}

body.fire4::after{
  animation-duration: 1.75s;
  filter: blur(14px) saturate(1.95) contrast(1.12);
  opacity: .98;
}

/* ===== Layout like g2 (topbar + centered stage) ===== */
.wrap{
  position:relative;
  z-index:1;
  height:100%;
  display:flex;
  flex-direction:column;
  padding: max(14px, env(safe-area-inset-top)) 14px max(14px, env(safe-area-inset-bottom));
  gap:12px;
}
.topbar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}

/* ===== g BACK BUTTON (FINAL SIMPLE VERSION) ===== */
.backBtn{
  appearance:none;
  border:0;
  background:rgba(255,255,255,.10);
  color:#fff;

  padding:7px 12px;
  font-size:14px;

  border-radius:999px;
  font-family:'Cinzel', serif;
  font-weight:900;
  letter-spacing:.4px;

  box-shadow:0 10px 24px rgba(0,0,0,.35);
  border:1px solid rgba(255,255,255,.18);

  cursor:pointer;
  display:inline-flex;
  align-items:center;
  justify-content:center;

  line-height:1;
  white-space:nowrap;
  -webkit-tap-highlight-color:transparent;
}

.hud{
  display:flex;
  align-items:center;
  gap:10px;
  font-family:'Noto Sans JP',sans-serif;
  font-size:var(--hudSize);
  color:#cbd5e1;
  user-select:none;
}
.hud .pill{
  padding:8px 10px;
  border-radius:999px;
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.14);
}
.hud b{color:#fff}

.stage{
  flex:1;
  display:flex;
  align-items:center;
  justify-content:center;
  min-height:0;
}

/* Card */
.card{
  width:min(760px, 100%);
  background:rgba(0,0,0,.35);
  border-radius:26px;
  padding:26px 22px 20px;
  text-align:center;
  box-shadow:0 20px 60px rgba(0,0,0,.5);
  border:1px solid var(--outline);
  position:relative;
  overflow:hidden;
  transform: scale(var(--unlockScale)) rotate(var(--unlockWobble));
  transition: transform .25s ease, box-shadow .25s ease, border-color .25s ease;
}

/* subtle inner sheen */
.card::before{
  content:"";
  position:absolute;
  inset:-2px;
  pointer-events:none;
  border-radius:26px;
  background:
    radial-gradient(520px 220px at 30% 0%, rgba(255,255,255,.10), transparent 60%),
    radial-gradient(560px 260px at 80% 0%, rgba(255,209,122,.14), transparent 62%),
    radial-gradient(900px 380px at 50% 120%, rgba(255,120,70, calc(.06 + var(--fireSpark)*.10)), transparent 62%);
  opacity:.9;
}

body.fire2 .card,
body.fire3 .card,
body.fire4 .card{
  box-shadow:
    0 20px 60px rgba(0,0,0,.50),
    0 0 50px var(--unlockGlow),
    0 0 120px rgba(255,209,122, calc(.06 + var(--fireSpark)*.10));
}

body.fire3 .card{ animation: cardThrill 0.85s ease-in-out infinite; }
body.fire4 .card{ animation: cardThrillWild 0.70s ease-in-out infinite; }

@keyframes cardThrill{
  0%,100%{ transform: scale(var(--unlockScale)) rotate(calc(var(--unlockWobble) * -1)); }
  50%{ transform: scale(calc(var(--unlockScale) + .015)) rotate(var(--unlockWobble)); }
}
@keyframes cardThrillWild{
  0%,100%{ transform: scale(var(--unlockScale)) rotate(calc(var(--unlockWobble) * -1)); }
  50%{ transform: scale(calc(var(--unlockScale) + .02)) rotate(var(--unlockWobble)); }
}

/* fire ring on card */
.fireRing{
  position:absolute;
  inset:10px;
  border-radius: 18px;
  pointer-events:none;
  opacity:0;
  background:
    radial-gradient(600px 220px at 30% 0%, var(--ringA), transparent 62%),
    radial-gradient(600px 240px at 70% 0%, var(--ringB), transparent 62%),
    radial-gradient(700px 260px at 50% 110%, rgba(255,209,122,.14), transparent 62%);
  filter: drop-shadow(0 0 18px rgba(255,209,122,.38));
}
body.fire1 .fireRing,
body.fire2 .fireRing,
body.fire3 .fireRing,
body.fire4 .fireRing{
  opacity:1;
  animation: firePulse 0.85s ease-in-out infinite;
}
body.fire3 .fireRing{animation-duration:.65s;}
body.fire4 .fireRing{animation-duration:.55s;}

@keyframes firePulse{
  0%,100%{filter: drop-shadow(0 0 22px var(--pulse1));}
  50%{filter: drop-shadow(0 0 44px var(--pulse2));}
}

/* Perfect run gold frame */
.card.perfect{
  border:2px solid rgba(255,209,102,.65);
  box-shadow:
    0 0 18px rgba(255,209,102,.28),
    0 0 46px rgba(255,209,102,.20),
    0 22px 70px rgba(0,0,0,.55);
}
.card.perfect::after{
  content:"";
  position:absolute;
  inset:-10px;
  border-radius:32px;
  pointer-events:none;
  background:conic-gradient(from 0deg,
    rgba(255,255,255,0) 0%,
    rgba(255,241,179,.75) 12%,
    rgba(255,255,255,0) 24%,
    rgba(255,209,102,.80) 38%,
    rgba(255,255,255,0) 52%,
    rgba(255,241,179,.70) 68%,
    rgba(255,255,255,0) 82%,
    rgba(255,209,102,.80) 94%,
    rgba(255,255,255,0) 100%
  );
  opacity:.55;
  filter:blur(0.6px);
  animation:goldSpin 3.6s linear infinite;
  mask:
    linear-gradient(#000 0 0) content-box,
    linear-gradient(#000 0 0);
  -webkit-mask:
    linear-gradient(#000 0 0) content-box,
    linear-gradient(#000 0 0);
  padding:10px;
}
@keyframes goldSpin{to{transform:rotate(360deg)}}

/* Header */
.header{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:6px;
  position:relative;
  z-index:1;
}
h1{
  font-size:clamp(26px,4.6vw,44px);
  font-weight:900;
  letter-spacing:.05em;
  line-height:1.05;
}
h1 small{
  display:block;
  margin-top:6px;
  font-family:'Noto Sans JP',system-ui;
  font-size:clamp(15px,2.6vw,22px);
  font-weight:900;
  color:#d7d7d7;
  letter-spacing:.02em;
}

/* Sentence */
#sentenceWrap{
  margin-top:22px;
  position:relative;
  z-index:1;
}
.sentence{
  font-family:'Cinzel',serif;
  font-size:clamp(22px, 4.8vw, 40px);
  font-weight:900;
  letter-spacing:.02em;
  line-height:1.25;
  text-shadow:
    0 2px 0 rgba(0,0,0,.95),
    0 6px 18px rgba(0,0,0,.75),
    0 0 22px rgba(0,0,0,.55);
}

.word{
  display:inline-block;
  padding:6px 8px;
  margin:4px 2px;
  border-radius:14px;
  cursor:pointer;
  user-select:none;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.10);
  box-shadow: 0 8px 18px rgba(0,0,0,.22);
  transition: transform .12s ease, background .12s ease, box-shadow .12s ease, border-color .12s ease;
  -webkit-tap-highlight-color: transparent;
}
.word:hover{ background:rgba(255,255,255,.09); }
.word:active{ transform: translateY(1px) scale(.99); }

.word.good{
  background: rgba(34,197,94,.16);
  border-color: rgba(34,197,94,.34);
  box-shadow:
    0 0 0 6px rgba(34,197,94,.10),
    0 0 40px rgba(34,197,94,.30),
    0 10px 22px rgba(0,0,0,.28);
}
.word.bad{
  background: rgba(239,68,68,.16);
  border-color: rgba(239,68,68,.34);
  animation: wordShake .36s ease;
  box-shadow:
    0 0 0 6px rgba(239,68,68,.10),
    0 0 40px rgba(239,68,68,.26),
    0 10px 22px rgba(0,0,0,.28);
}
@keyframes wordShake{
  0%{transform:translateX(0)}
  25%{transform:translateX(-7px)}
  50%{transform:translateX(7px)}
  75%{transform:translateX(-5px)}
  100%{transform:translateX(0)}
}

/* Feedback (reuse hearts + fart) */
.feedback{
  margin-top:16px;
  min-height:54px;
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
  z-index:1;
}
.heart{
  font-size:46px;
  color:var(--good);
  animation:pop .6s ease;
  filter: drop-shadow(0 0 16px rgba(34,197,94,.45));
}
@keyframes pop{
  0%{transform:scale(.6);opacity:0}
  60%{transform:scale(1.2)}
  100%{transform:scale(1)}
}
.fart{
  font-size:44px;
  color:var(--bad);
  animation:shake .4s ease;
  filter: drop-shadow(0 0 16px rgba(239,68,68,.35));
}
@keyframes shake{
  0%{transform:translateX(0)}
  25%{transform:translateX(-7px)}
  50%{transform:translateX(7px)}
  75%{transform:translateX(-5px)}
  100%{transform:translateX(0)}
}

/* Footer */
footer{
  width:100%;
  margin-top:14px;
  text-align:center;
  font-family:'Cinzel',serif;
  font-weight:900;
  color:#cbd5e1;
  font-size:18px;
  letter-spacing:.06em;
}

/* Result */
#result{display:none}
.resultScore{
  margin-top:18px;
  font-size:40px;
  font-weight:900;
}
.good{color:#22c55e}
.mid{color:#ffd166}
.bad{color:#ef4444}

.perfectTag{
  margin-top:12px;
  font-family:'Cinzel',serif;
  font-weight:900;
  letter-spacing:.08em;
  color:#ffd166;
  text-shadow:0 0 10px rgba(255,209,102,.35), 0 0 22px rgba(255,209,102,.22);
  font-size:clamp(16px,2.6vw,20px);
}
.perfectTag small{
  display:block;
  margin-top:6px;
  font-family:'Noto Sans JP',system-ui;
  letter-spacing:.02em;
  color:#ffe7b5;
  font-weight:900;
}

.bottom{
  margin-top:18px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  justify-content:center;
  align-items:center;
}
a.back{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  padding:10px 14px;
  border-radius:14px;
  text-decoration:none;
  background:rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.18);
  color:#fff;
  font-family:'Cinzel',serif;
  font-weight:900;
  -webkit-tap-highlight-color: transparent;
}
a.back span{
  font-family:'Noto Sans JP',system-ui;
  font-weight:900;
  color:#d7d7d7;
}

/* ===========================
   FIRE BANNER (MATCH g2)
   =========================== */
.fireBanner{
  position: fixed;
  left: 50%;
  top: calc(max(12px, env(safe-area-inset-top)) + 6px);
  transform: translateX(-50%);
  z-index: 70;

  display:grid;
  grid-template-columns:16px 1fr;
  grid-template-rows:auto auto;
  column-gap:10px;
  row-gap:2px;

  padding:12px 14px;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.18);
  background: rgba(15,23,42,.58);
  box-shadow: 0 16px 50px rgba(0,0,0,.55);

  overflow:hidden;
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);

  pointer-events:none;
  opacity:0;
  transition: opacity .18s ease;
}
.fireBanner.show{opacity:1}

.fireBanner .bannerFX{
  position:absolute;
  inset:-40%;
  pointer-events:none;
  z-index:0;
  background:
    radial-gradient(55% 45% at 20% 20%, rgba(255,214,102,.18), transparent 60%),
    radial-gradient(55% 45% at 80% 20%, rgba(255,90,160,.16), transparent 60%),
    radial-gradient(70% 60% at 50% 90%, rgba(90,255,214,.14), transparent 62%);
  filter: blur(10px) saturate(1.4);
  opacity:.85;
  mix-blend-mode: screen;
  animation: bannerDrift 2.8s ease-in-out infinite;
}
@keyframes bannerDrift{
  0%{transform: translate(-1%, -1%) rotate(-1deg) scale(1.02)}
  50%{transform: translate( 1%,  1%) rotate( 1deg) scale(1.06)}
  100%{transform: translate(-1%, -1%) rotate(-1deg) scale(1.02)}
}

.fireDot{
  width:14px;height:14px;border-radius:999px;
  background: radial-gradient(circle at 30% 30%, #fff6d8, #ffd17a 45%, #ff6b3d 100%);
  box-shadow: 0 0 26px rgba(255,209,122,.80);
  grid-column:1;
  grid-row:1 / span 2;
  align-self:center;
  position:relative;
  z-index:2;
}

.fireBanner .en{
  grid-column:2; grid-row:1;
  font-family:'Cinzel',serif;
  font-weight:900;
  letter-spacing:.4px;
  font-size: clamp(18px, 3.1vw, 28px);
  line-height:1.05;
  position:relative;
  z-index:2;
  text-shadow: 0 2px 0 rgba(0,0,0,.25);
}
.fireBanner .jp{
  grid-column:2; grid-row:2;
  margin-top:6px;
  font-family:'Noto Sans JP',sans-serif;
  font-weight:900;
  font-size: clamp(14px, 2.7vw, 20px);
  line-height:1.05;
  opacity:.98;
  position:relative;
  z-index:2;
  text-shadow:
    0 2px 0 rgba(0,0,0,.90),
    0 0 10px rgba(0,0,0,.75),
    0 0 18px rgba(0,0,0,.55);
}

.fireBanner.fire1{ background: radial-gradient(120% 140% at 20% 20%, rgba(255,214,102,.92), rgba(255,120,90,.45) 55%, rgba(20,30,60,.12) 100%); border-color: rgba(255,214,102,.58); }
.fireBanner.fire2{ background: radial-gradient(120% 140% at 20% 20%, rgba(255,90,160,.92), rgba(255,214,102,.50) 55%, rgba(20,30,60,.12) 100%); border-color: rgba(255,90,160,.58); }
.fireBanner.fire3{ background: radial-gradient(120% 140% at 20% 20%, rgba(90,255,214,.92), rgba(120,130,255,.52) 55%, rgba(20,30,60,.12) 100%); border-color: rgba(90,255,214,.58); }
.fireBanner.fire4{
  border-color: rgba(255,255,255,.38);
  background: radial-gradient(120% 160% at 15% 20%,
    rgba(255,255,255,.92),
    rgba(255,214,102,.62) 22%,
    rgba(255,90,160,.58) 48%,
    rgba(90,255,214,.58) 70%,
    rgba(120,130,255,.48) 100%
  );
}
.fireBanner.fire4 .bannerFX{
  background:
    conic-gradient(from 0deg,
      rgba(255,214,102,0),
      rgba(255,214,102,.30),
      rgba(255,90,160,.26),
      rgba(90,255,214,.26),
      rgba(120,130,255,.22),
      rgba(255,214,102,.30),
      rgba(255,214,102,0)
    );
  filter: blur(12px) saturate(1.8);
  opacity:.95;
  animation: wildSpin 1.2s linear infinite;
}

/* ===========================
   START OVERLAY (JP EXPLANATION)
   =========================== */
.startOverlay{
  position:fixed;
  inset:0;
  z-index:90;
  display:flex;
  align-items:center;
  justify-content:center;
  padding: max(18px, env(safe-area-inset-top)) 16px max(18px, env(safe-area-inset-bottom));
  background: rgba(5,8,18,.62);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}
.startOverlay.hide{ opacity:0; pointer-events:none; transition: opacity .18s ease; }

.startPanel{
  width:min(760px, 100%);
  background: rgba(0,0,0,.42);
  border:1px solid rgba(255,255,255,.16);
  border-radius:26px;
  box-shadow: 0 26px 70px rgba(0,0,0,.65);
  padding:24px 18px 18px;
  position:relative;
  overflow:hidden;
}
.startPanel::before{
  content:"";
  position:absolute;
  inset:-20%;
  background:
    radial-gradient(55% 45% at 20% 20%, rgba(255,214,102,.18), transparent 60%),
    radial-gradient(55% 45% at 80% 20%, rgba(255,90,160,.16), transparent 60%),
    radial-gradient(70% 60% at 50% 90%, rgba(90,255,214,.14), transparent 62%);
  filter: blur(14px) saturate(1.5);
  opacity:.9;
  mix-blend-mode: screen;
  pointer-events:none;
}
.startTitle{
  position:relative;
  z-index:1;
  text-align:center;
}
.startTitle h2{
  font-size:clamp(26px, 4.6vw, 44px);
  font-weight:900;
  letter-spacing:.05em;
}
.startTitle h2 small{
  display:block;
  margin-top:6px;
  font-family:'Noto Sans JP',system-ui;
  font-size:clamp(14px, 2.6vw, 20px);
  font-weight:900;
  color:#d7d7d7;
}
.startText{
  position:relative;
  z-index:1;
  margin-top:16px;
  font-family:'Noto Sans JP',system-ui;
  font-weight:900;
  color:#e5e7eb;
  text-align:left;
  line-height:1.55;
  font-size:clamp(14px, 2.8vw, 18px);
  text-shadow: 0 2px 0 rgba(0,0,0,.65);
}
.startText .enLine{
  margin-top:10px;
  font-family:'Cinzel',serif;
  letter-spacing:.02em;
  color:#fff;
  opacity:.92;
}

button.primary{
  margin-top:16px;
  width:100%;
  padding:14px;
  font-size:20px;
  border-radius:16px;
  border:none;
  font-weight:900;
  cursor:pointer;
  color:#0b1020;
  background: rgba(255,209,122,.95);
  border:1px solid rgba(255,209,122,.85);
  box-shadow:
    0 16px 40px rgba(0,0,0,.45),
    0 0 70px rgba(255,120,70,.28);
  display:flex;
  align-items:baseline;
  justify-content:center;
  gap:10px;
  -webkit-tap-highlight-color: transparent;
  position:relative;
  z-index:1;
}
button.primary span.jpBtn{
  font-family:'Noto Sans JP',system-ui;
  font-weight:900;
  font-size:14px;
  color:#0b1020;
  text-shadow:none;
}
button.primary:active{transform: translateY(1px)}

@media (prefers-reduced-motion: reduce){
  body::before, body::after{animation:none !important}
  .fireRing,.card{animation:none !important; transition:none !important}
  .heart,.fart{animation:none !important}
  .fireBanner .bannerFX{animation:none !important}
}
</style>
</head>

<body>

<div class="wrap">
  <div class="topbar">
    <button class="backBtn" id="backBtn">MENU„Éª„É°„Éã„É•„Éº</button>

    <div class="hud" aria-label="Progress">
      <div class="pill">Q <b id="qNum">1</b>/<span id="qTotal">0</span></div>
      <div class="pill">Score <b id="hudScore">0</b></div>
      <div class="pill">Streak <b id="hudStreak">0</b></div>
    </div>
  </div>

  <div class="stage">
    <div class="card" id="card">
      <div class="fireRing" aria-hidden="true"></div>

      <div id="game">
        <div class="header" id="prompt">
          <h1>Spot the Mistake<small>„Åæ„Å°„Åå„ÅÑ„Åï„Åå„Åó</small></h1>
        </div>

        <div id="sentenceWrap">
          <div class="sentence" id="sentence" aria-label="Sentence"></div>
        </div>

        <div class="feedback" id="feedback"></div>
        <footer>Bryan's English School</footer>
      </div>

      <div id="result">
        <div class="header">
          <h1>RESULT<small>„Åë„Å£„Åã</small></h1>
        </div>

        <div class="resultScore" id="resultScore"></div>
        <div class="resultScore" id="resultDetail" style="margin-top:10px;font-size:22px;color:#cbd5e1;font-family:'Noto Sans JP',system-ui;font-weight:900;"></div>

        <div class="perfectTag" id="perfectTag" style="display:none;">
          PERFECT RUN
          <small>„Éë„Éº„Éï„Çß„ÇØ„ÉàÔºÅ</small>
        </div>

        <div class="bottom">
          <a class="back" href="index.html">Back to Menu <span>„É°„Éã„É•„Éº„Å∏</span></a>
          <a class="back" href="" id="retryLink">Try Again <span>„ÇÇ„ÅÜ‰∏ÄÂõû</span></a>
        </div>

        <footer>Bryan's English School</footer>
      </div>
    </div>
  </div>

  <!-- Fire popup (MATCH g2) -->
  <div class="fireBanner" id="fireBanner" role="status" aria-live="polite">
    <div class="bannerFX" aria-hidden="true"></div>
    <span class="fireDot" aria-hidden="true"></span>
    <div class="en" id="fireEn">You‚Äôre on fire!</div>
    <div class="jp" id="fireJp">„Éé„Å£„Å¶„Åç„ÅüÔºÅ</div>
  </div>
</div>

<!-- Start overlay -->
<div class="startOverlay" id="startOverlay" role="dialog" aria-modal="true" aria-label="How to play">
  <div class="startPanel">
    <div class="startTitle">
      <h2>Spot the Mistake<small>„Åæ„Å°„Åå„ÅÑ„Åï„Åå„Åó</small></h2>
    </div>
    <div class="startText">
      <div><b>„Åæ„Å°„Åå„ÅÑ„ÇíË¶ã„Å§„Åë„Çâ„Çå„ÇãÔºü</b></div>
      <div style="margin-top:10px;">
        Ëã±Êñá„ÅÆ‰∏≠„Å´ <b>„Åæ„Å°„Åå„ÅÑ„ÅåÔºë„Å§</b> „ÅÇ„Çä„Åæ„Åô„ÄÇ<br>
        <b>„Çπ„Éö„É´„Åå„Åæ„Å°„Åå„Å£„Å¶„ÅÑ„ÇãÂçòË™û</b> „Åæ„Åü„ÅØ<br>
        <b>„ÅÑ„Çâ„Å™„ÅÑÔºà‰ΩôË®à„Å™ÔºâÂçòË™û</b> „Åß„Åô„ÄÇ
      </div>
      <div style="margin-top:10px;">
        üëâ <b>„Åæ„Å°„Åå„Å£„Å¶„ÅÑ„ÇãÂçòË™û„Çí„ÇØ„É™„ÉÉ„ÇØÔºè„Çø„ÉÉ„Éó</b> „Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
      </div>
      <div class="enLine">Can you spot the mistake? Tap the misspelled word or extra word.</div>
    </div>
    <button class="primary" id="startBtn">START <span class="jpBtn">„Çπ„Çø„Éº„Éà</span></button>
  </div>
</div>

<script>
function $(q){ return document.querySelector(q); }

/* =========================
REMINDERS
‚úÖ Same-folder SFX:
   ding.mp3, fart.mp3, fire.mp3, level4.mp3
‚úÖ Level 4 sound key = "level4"
‚úÖ Fire banner logic:
   - Triggers ONLY on level-up (prevents spam)
   - Stays visible while streak remains in fire zone
   - Hides when streak drops to 0
========================= */

/* ---------- WebAudio SFX (same-folder) ---------- */
const SFX = (() => {
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let ctx = null;
  let master = null;
  const buf = new Map();
  let unlocked = false;

  function ensure(){
    if (!ctx) {
      ctx = new AudioCtx();
      master = ctx.createGain();
      master.gain.value = 1;
      master.connect(ctx.destination);
    }
  }

  async function loadOne(name, url){
    ensure();
    const res = await fetch(url, { cache: "force-cache" });
    if(!res.ok) throw new Error(`SFX fetch failed: ${name} -> ${url} (${res.status})`);
    const arr = await res.arrayBuffer();
    const b = await ctx.decodeAudioData(arr);
    buf.set(name, b);
  }

  async function preload(){
    ensure();
    const jobs = [
      ["ding","ding.mp3"],
      ["fart","fart.mp3"],
      ["fire","fire.mp3"],
      ["level4","level4.mp3"],
    ].map(([name,url]) => loadOne(name,url).catch(()=>null));
    await Promise.all(jobs);
  }

  function unlock(){
    ensure();
    if (unlocked) return;
    unlocked = true;

    if (ctx.state === "suspended") ctx.resume().catch(()=>{});
    const b = ctx.createBuffer(1, 1, 22050);
    const src = ctx.createBufferSource();
    src.buffer = b;
    src.connect(master);
    try { src.start(0); } catch(e) {}
  }

  function play(name, volume=1){
    if (!ctx) return;
    let b = buf.get(name);
    if (!b && name === "level4") b = buf.get("fire");
    if (!b) return;

    if (ctx.state === "suspended") ctx.resume().catch(()=>{});

    const src = ctx.createBufferSource();
    src.buffer = b;

    const g = ctx.createGain();
    g.gain.value = Math.max(0, Math.min(1, volume));

    src.connect(g);
    g.connect(master);

    try { src.start(0); } catch(e) {}
  }

  return { preload, unlock, play };
})();

/* =========================
   DATA (ENTIRE MONTH = 60 QUESTIONS)
   RULE: only misspelled word OR extra word
   Each item:
   - correct: correct sentence
   - wrong:   sentence with ONE misspelling or ONE duplicated word
   - target:  the exact word to tap (misspelled token OR duplicated token)
   ========================= */
const DATA = [
  // Goals (15)
  { correct:"What is your goal this year?", wrong:"What is your gole this year?", target:"gole" },
  { correct:"Why is it important to you?", wrong:"Why is it importent to you?", target:"importent" },
  { correct:"How will you reach your goal?", wrong:"How will you reach reach your goal?", target:"reach" },
  { correct:"Who helps you stay motivated?", wrong:"Who helps you stay motivaited?", target:"motivaited" },
  { correct:"What habit do you want to change?", wrong:"What habit do you want to change change?", target:"change" },
  { correct:"Do you like making resolutions?", wrong:"Do you like making resolutons?", target:"resolutons" },
  { correct:"What do you want to try this year?", wrong:"What do you want to try this this year?", target:"this" },
  { correct:"What‚Äôs something new you learned recently?", wrong:"What‚Äôs something new you learned receintly?", target:"receintly" },
  { correct:"Is it easy to keep goals?", wrong:"Is it easy to keep goalls?", target:"goalls" },
  { correct:"What happens when you don‚Äôt try?", wrong:"What happens when you don‚Äôt dont try?", target:"dont" },
  { correct:"What makes you feel proud?", wrong:"What makes you feel pround?", target:"pround" },
  { correct:"What‚Äôs your dream for the future?", wrong:"What‚Äôs your dream for the futuer?", target:"futuer" },
  { correct:"How do you stay positive?", wrong:"How do you stay possitive?", target:"possitive" },
  { correct:"Who inspires you?", wrong:"Who inspires inspires you?", target:"inspires" },
  { correct:"How can English help your goals?", wrong:"How can English help your goales?", target:"goales" },

  // Daily routine (15)
  { correct:"What time do you wake up?", wrong:"What time do you wake up up?", target:"up" },
  { correct:"What do you do after school?", wrong:"What do you do do after school?", target:"do" },
  { correct:"Do you help at home?", wrong:"Do you help at hoem?", target:"hoem" },
  { correct:"What do you do every morning?", wrong:"What do you do every moring?", target:"moring" },
  { correct:"What time do you eat dinner?", wrong:"What time do you eat diner?", target:"diner" },
  { correct:"Do you use your phone before bed?", wrong:"Do you use your phone before before bed?", target:"before" },
  { correct:"How do you get ready for school?", wrong:"How do you get ready for scool?", target:"scool" },
  { correct:"What is your favorite part of the day?", wrong:"What is your favorte part of the day?", target:"favorte" },
  { correct:"When do you do homework?", wrong:"When do you do homewrok?", target:"homewrok" },
  { correct:"Do you study every day?", wrong:"Do you study every day day?", target:"day" },
  { correct:"What time do you go to bed?", wrong:"What time do you go to to bed?", target:"to" },
  { correct:"What do you do on weekends?", wrong:"What do you do on weekens?", target:"weekens" },
  { correct:"What do you usually eat for breakfast?", wrong:"What do you ussually eat for breakfast?", target:"ussually" },
  { correct:"Who do you spend time with after school?", wrong:"Who do you spend time with after after school?", target:"after" },
  { correct:"What time do you finish dinner?", wrong:"What time do you finish dinenr?", target:"dinenr" },

  // Health (15)
  { correct:"What do you do to stay healthy?", wrong:"What do you do to stay healhty?", target:"healhty" },
  { correct:"How many hours do you sleep?", wrong:"How many hours do you slepe?", target:"slepe" },
  { correct:"Do you eat vegetables every day?", wrong:"Do you eat vegtables every day?", target:"vegtables" },
  { correct:"What sports do you play?", wrong:"What sports do you play play?", target:"play" },
  { correct:"How do you relax after school?", wrong:"How do you relax after shcool?", target:"shcool" },
  { correct:"Do you like exercise?", wrong:"Do you like excercise?", target:"excercise" },
  { correct:"What food gives you energy?", wrong:"What food gives you enegy?", target:"enegy" },
  { correct:"Do you drink enough water?", wrong:"Do you drink enough enought water?", target:"enought" },
  { correct:"What time do you go to sleep?", wrong:"What time do you go to sleep sleep?", target:"sleep" },
  { correct:"What should people do when they‚Äôre sick?", wrong:"What should people do when they‚Äôre sike?", target:"sike" },
  { correct:"Do you often feel tired?", wrong:"Do you often feel tirred?", target:"tirred" },
  { correct:"How do you stay happy?", wrong:"How do you stay happ y?", target:"happ" },
  { correct:"Is health important to you?", wrong:"Is health important to to you?", target:"to" },
  { correct:"What bad habit do you want to change?", wrong:"What bad habit do you want to chagne?", target:"chagne" },
  { correct:"What‚Äôs your favorite healthy food?", wrong:"What‚Äôs your favorite healthy foood?", target:"foood" },

  // School / self (15)
  { correct:"What do you want to learn this year?", wrong:"What do you want to learn this yer?", target:"yer" },
  { correct:"What are you good at?", wrong:"What are you good at at?", target:"at" },
  { correct:"What do you find difficult?", wrong:"What do you find dificult?", target:"dificult" },
  { correct:"How do you keep trying?", wrong:"How do you keep tryng?", target:"tryng" },
  { correct:"What helps you focus?", wrong:"What helps you focuss?", target:"focuss" },
  { correct:"Do you believe in yourself?", wrong:"Do you believe in yourself yourself?", target:"yourself" },
  { correct:"What do you do when you make mistakes?", wrong:"What do you do when you make mistakess?", target:"mistakess" },
  { correct:"Who inspires you?", wrong:"Who inspir es you?", target:"inspir" },
  { correct:"What makes you happy at school?", wrong:"What makes you happy at schoool?", target:"schoool" },
  { correct:"What is one thing you want to improve?", wrong:"What is one thing you want to imporve?", target:"imporve" },
  { correct:"Do you like challenges?", wrong:"Do you like challanges?", target:"challanges" },
  { correct:"How do you relax?", wrong:"How do you relax relax?", target:"relax" },
  { correct:"What do you do when you feel nervous?", wrong:"What do you do when you feel nervus?", target:"nervus" },
  { correct:"How do you motivate yourself?", wrong:"How do you motivate yourself yoursel f?", target:"yoursel" },
  { correct:"What‚Äôs your biggest goal right now?", wrong:"What‚Äôs your biggest goal right now now?", target:"now" },
];

function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

/* =========================
   State
   ========================= */
let order = [];
let idx = 0;
let score = 0;
let streak = 0;
let firstTryHits = 0;
let attemptsThisQ = 0;
let anyWrongEver = false;
let locked = false;
let lastTapAt = 0;

/* hooks */
const sentenceEl = $('#sentence');
const fbEl = $('#feedback');
const cardEl = $('#card');

const qNumEl = $('#qNum');
const qTotalEl = $('#qTotal');
const hudScoreEl = $('#hudScore');
const hudStreakEl = $('#hudStreak');

const fireBanner = $('#fireBanner');
const fireEn = $('#fireEn');
const fireJp = $('#fireJp');

const startOverlay = $('#startOverlay');
const startBtn = $('#startBtn');

/* helpers */
function stripPunct(w){
  return (w||"").replace(/^[^\w']+|[^\w']+$/g, "");
}
function normWord(w){
  return stripPunct(w).toLowerCase();
}

function updateHud(){
  qNumEl.textContent = String(Math.min(idx+1, DATA.length));
  qTotalEl.textContent = String(DATA.length);
  hudScoreEl.textContent = String(score);
  hudStreakEl.textContent = String(streak);
}

/* ---------- Fire level thresholds (MATCH g2) ---------- */
function getFireLevelFromStreak(n){
  if(n >= 15) return 4;
  if(n >= 10) return 3;
  if(n >= 6)  return 2;
  if(n >= 3)  return 1;
  return 0;
}

/* ---------- Fire level (BODY) ---------- */
function applyBodyFireFromStreak(){
  const lv = getFireLevelFromStreak(streak);
  document.body.classList.remove("fire1","fire2","fire3","fire4");
  if(lv) document.body.classList.add(`fire${lv}`);
}

/* ---------- Fire Banner (MATCH messages + Level 4) ---------- */
const FIRE_MSG = {
  1: { en:"You are awesome!",                     jp:"„Åô„Åî„ÅÑÔºÅ" },
  2: { en:"You are even more awesome!",           jp:"„ÇÇ„Å£„Å®„Åô„Åî„ÅÑÔºÅ" },
  3: { en:"What? You are the most awesome!",      jp:"„Åà„Å£ÔºÅÔºü‰∏ÄÁï™„Åô„Åî„ÅÑÔºÅ" },
  4: { en:"You are the smartest person alive!!!", jp:"„ÅÇ„Å™„Åü„ÅØ‰∏ñÁïå‰∏Ä„Åã„Åó„Åì„ÅÑÔºÅÔºÅÔºÅ" }
};

let lastFireLevel = 0;

function playLevelSound(lv){
  if(lv === 1 || lv === 2 || lv === 3){
    SFX.play("fire", 1);
    return;
  }
  if(lv === 4){
    try{ SFX.play("level4", 1); } catch(e){ SFX.play("fire", 1); }
  }
}

function hideFireBanner(){
  if(!fireBanner) return;
  fireBanner.classList.remove("show","fire1","fire2","fire3","fire4");
}

function showFireBanner(level){
  const msg = FIRE_MSG[level];
  if(!msg || !fireBanner) return;

  fireEn.textContent = msg.en;
  fireJp.textContent = msg.jp;

  fireBanner.classList.remove("fire1","fire2","fire3","fire4");
  fireBanner.classList.add(`fire${level}`);

  fireBanner.classList.add("show");
  playLevelSound(level);
}

function maybeTriggerFire(){
  const lv = getFireLevelFromStreak(streak);

  if(lv === 0){
    lastFireLevel = 0;
    hideFireBanner();
    return;
  }

  if(lv > lastFireLevel){
    showFireBanner(lv);
    lastFireLevel = lv;
  }
}

/* =========================
   Game logic
   ========================= */
function resetGame(){
  order = shuffle([...Array(DATA.length)].map((_,i)=>i));
  idx = 0;
  score = 0;
  streak = 0;
  firstTryHits = 0;
  attemptsThisQ = 0;
  anyWrongEver = false;
  locked = false;

  lastFireLevel = 0;
  document.body.classList.remove("fire1","fire2","fire3","fire4");
  hideFireBanner();

  $('#game').style.display='block';
  $('#result').style.display='none';
  cardEl.classList.remove('perfect');
  $('#perfectTag').style.display='none';

  updateHud();
  applyBodyFireFromStreak();
  maybeTriggerFire();
}

function clearFeedback(){
  fbEl.textContent = "";
}

function renderSentence(){
  clearFeedback();
  attemptsThisQ = 0;
  locked = false;

  const d = DATA[order[idx]];
  const words = d.wrong.split(/\s+/);

  sentenceEl.innerHTML = "";
  words.forEach((w, i) => {
    const sp = document.createElement('span');
    sp.className = 'word';
    sp.textContent = w;
    sp.setAttribute('role','button');
    sp.setAttribute('tabindex','0');
    sp.dataset.raw = w;

    sp.addEventListener('pointerup', (e)=>{
      e.preventDefault();
      e.stopPropagation();
      tapWord(sp);
    }, { passive:false });

    sp.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' || e.key === ' '){
        e.preventDefault();
        tapWord(sp);
      }
    });

    sentenceEl.appendChild(sp);
    sentenceEl.appendChild(document.createTextNode(' '));
  });

  updateHud();
  applyBodyFireFromStreak();
  maybeTriggerFire();
}

function tapWord(span){
  if(locked) return;

  // small anti-mash cooldown
  const now = performance.now();
  if(now - lastTapAt < 220) return;
  lastTapAt = now;

  const d = DATA[order[idx]];
  const tapped = normWord(span.dataset.raw);
  const target = normWord(d.target);

  attemptsThisQ++;

  // correct tap
  if(tapped === target){
    locked = true;
    span.classList.add('good');
    fbEl.innerHTML = '<div class="heart">‚ù§</div>';

    // scoring: 1st = +2, 2nd = +1, 3rd+ = +0
    if(attemptsThisQ === 1){
      score += 2;
      streak++;
      firstTryHits++;
    }else if(attemptsThisQ === 2){
      score += 1;
      streak = 0;
    }else{
      streak = 0;
    }

    SFX.play('ding', 1);

    // show corrected sentence after short beat
    setTimeout(()=>{
      sentenceEl.textContent = d.correct;
    }, 240);

    updateHud();
    applyBodyFireFromStreak();
    maybeTriggerFire();

    setTimeout(next, 820);
    return;
  }

  // wrong tap
  anyWrongEver = true;
  streak = 0;

  // visual on tapped word only
  span.classList.remove('good');
  span.classList.add('bad');
  fbEl.innerHTML = '<div class="fart">üí®</div>';
  SFX.play('fart', 1);

  updateHud();
  applyBodyFireFromStreak();
  maybeTriggerFire();

  setTimeout(()=>{ span.classList.remove('bad'); }, 320);
}

function next(){
  idx++;
  if(idx >= order.length) finish();
  else renderSentence();
}

/* finish */
function finish(){
  $('#game').style.display='none';
  $('#result').style.display='block';

  qNumEl.textContent = String(DATA.length);
  qTotalEl.textContent = String(DATA.length);
  hudScoreEl.textContent = String(score);
  hudStreakEl.textContent = String(streak);

  const maxScore = DATA.length * 2;
  const firstTryPct = Math.round((firstTryHits / DATA.length) * 100);
  const scorePct = Math.round((score / maxScore) * 100);

  const s = $('#resultScore');
  s.textContent = `First-Try: ${firstTryPct}%`;
  s.className = 'resultScore ' + (firstTryPct>=80?'good':firstTryPct>=50?'mid':'bad');

  const detail = $('#resultDetail');
  detail.textContent = `Score: ${score} / ${maxScore}  Ôºà${scorePct}%Ôºâ`;

  const retry = $('#retryLink');
  if(retry) retry.href = window.location.pathname.split('/').pop() || '';

  if(!anyWrongEver){
    cardEl.classList.add('perfect');
    $('#perfectTag').style.display='block';
  }
}

function goMenu(e){
  e.preventDefault();
  e.stopPropagation();
  if (history.length > 1) history.back();
  else window.location.href = "../index.html"; // change if needed
}

const backBtn = document.getElementById("backBtn");
if(backBtn){
  backBtn.addEventListener("pointerup", goMenu, { passive:false });
  backBtn.addEventListener("click", goMenu, { passive:false });
}

/* =========================
   STILL TEXT STABILIZER (optional but consistent)
   - Keeps #sentenceWrap visually still during fire3/4 card wobble
   ========================= */
const prefersReduced =
  window.matchMedia &&
  window.matchMedia('(prefers-reduced-motion: reduce)').matches;

function parseMatrix2D(t){
  if(!t || t === "none") return null;
  const m = t.match(/matrix\(([^)]+)\)/);
  if(!m) return null;
  const parts = m[1].split(",").map(v=>parseFloat(v.trim()));
  if(parts.length !== 6 || parts.some(Number.isNaN)) return null;
  return parts;
}

function invertMatrix2D(m){
  const [a,b,c,d,e,f] = m;
  const det = a*d - b*c;
  if(!det) return null;
  const id = 1/det;
  return [
    d*id,
   -b*id,
   -c*id,
    a*id,
   -(d*e - c*f)*id,
   -(a*f - b*e)*id
  ];
}

let stabilizeRAF = 0;
function stabilizeSentenceLoop(){
  cancelAnimationFrame(stabilizeRAF);

  const target = document.querySelector("#sentenceWrap");
  const card   = document.querySelector("#card");
  if(!target || !card) return;

  if(prefersReduced){
    target.style.transform = "none";
    return;
  }

  const tick = () => {
    const fire3 = document.body.classList.contains("fire3");
    const fire4 = document.body.classList.contains("fire4");

    if(!fire3 && !fire4){
      target.style.transform = "none";
      stabilizeRAF = requestAnimationFrame(tick);
      return;
    }

    const m = parseMatrix2D(getComputedStyle(card).transform);
    if(!m){
      target.style.transform = "none";
      stabilizeRAF = requestAnimationFrame(tick);
      return;
    }

    const inv = invertMatrix2D(m);
    if(!inv){
      target.style.transform = "none";
      stabilizeRAF = requestAnimationFrame(tick);
      return;
    }

    target.style.transform =
      `matrix(${inv[0]},${inv[1]},${inv[2]},${inv[3]},${inv[4]},${inv[5]})`;

    stabilizeRAF = requestAnimationFrame(tick);
  };

  stabilizeRAF = requestAnimationFrame(tick);
}

/* =========================
   Start overlay
   ========================= */
function beginFromOverlay(){
  // unlock audio on user gesture (Safari)
  try{ SFX.unlock(); }catch(e){}

  if(startOverlay){
    startOverlay.classList.add('hide');
    setTimeout(()=>{ startOverlay.style.display = 'none'; }, 220);
  }

  resetGame();
  renderSentence();
  stabilizeSentenceLoop();
}

if(startBtn){
  startBtn.addEventListener('pointerup', (e)=>{ e.preventDefault(); beginFromOverlay(); }, { passive:false });
  startBtn.addEventListener('click', (e)=>{ e.preventDefault(); beginFromOverlay(); }, { passive:false });
}

/* boot: preload audio; wait for overlay start */
(async function boot(){
  try{ await SFX.preload(); }catch(e){}
  // do NOT start game yet (overlay controls start)
  qTotalEl.textContent = String(DATA.length);
})();

window.addEventListener("pointerdown", () => { try{ SFX.unlock(); }catch(e){} }, { once:true, passive:true });
window.addEventListener("touchstart", () => { try{ SFX.unlock(); }catch(e){} }, { once:true, passive:true });
</script>

</body>
</html>
